<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>é‡‘èç³»çµ±å„€è¡¨æ¿ Pro v4.0 - Supabase é›²ç«¯ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-alt: #020617;
      --card: #0b1120;
      --card-soft: #111827;
      --primary: #3b82f6;
      --accent: #22c55e;
      --danger: #ef4444;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --yellow: #eab308;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
    }

    a { color: var(--primary); text-decoration: none; }

    /* ===== Auth é  ===== */
    .auth-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #020617 0, #020617 55%, #000 100%);
    }
    .auth-card {
      width: 100%;
      max-width: 420px;
      background: #020617;
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 32px 28px 28px;
      box-shadow: 0 24px 80px rgba(0,0,0,0.8);
    }
    .auth-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }
    .auth-logo {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: radial-gradient(circle at 20% 20%, #22c55e, #0ea5e9 45%, #1d4ed8 80%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .auth-title-text {
      font-size: 18px;
      font-weight: 600;
    }
    .auth-subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 20px;
    }
    .auth-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 18px;
    }
    .auth-cloud-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }
    .auth-group { margin-bottom: 16px; }
    .auth-group label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .auth-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text);
      font-size: 13px;
      outline: none;
    }
    .auth-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(59,130,246,0.5);
    }
    .auth-btn {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 10px 0;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 4px;
    }
    .auth-btn-primary {
      background: linear-gradient(135deg, #2563eb, #22c55e);
      color: #fff;
      box-shadow: 0 10px 30px rgba(37,99,235,0.6);
    }
    .auth-btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .auth-toggle {
      margin-top: 12px;
      font-size: 13px;
      color: var(--muted);
      text-align: center;
    }
    .auth-toggle a { cursor: pointer; }
    .auth-msg {
      font-size: 12px;
      margin-bottom: 12px;
      padding: 8px 10px;
      border-radius: 8px;
    }
    .auth-msg.error {
      border: 1px solid var(--danger);
      color: var(--danger);
      background: rgba(239,68,68,0.1);
    }
    .auth-msg.success {
      border: 1px solid var(--accent);
      color: var(--accent);
      background: rgba(34,197,94,0.08);
    }
    .hidden { display: none; }

    /* ===== v2.4 å„€è¡¨æ¿ Layout ===== */
    .app {
      min-height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr;
      background: linear-gradient(135deg, #020617 0, #020617 40%, #020617 100%);
    }
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      background: rgba(15,23,42,0.95);
      backdrop-filter: blur(16px);
      position: sticky;
      top: 0;
      z-index: 20;
    }
    .title-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: radial-gradient(circle at 20% 20%, #22c55e, #0ea5e9 45%, #1d4ed8 80%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .title-main { font-weight: 600; }
    .title-sub { font-size: 12px; color: var(--muted); }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 11px;
      color: var(--muted);
    }
    .cloud-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }
    .user-block {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .sync-status {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }
    .sync-status span.status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(34,197,94,0.4);
      color: #bbf7d0;
      background: rgba(22,163,74,0.08);
    }
    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }
    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #fbbf24, #f97316 60%, #9f1239);
      border: 1px solid rgba(148,163,184,0.3);
    }

    .layout {
      display: grid;
      grid-template-columns: 220px 1fr;
      min-height: 0;
      height: calc(100vh - 56px);
    }
    .sidebar {
      border-right: 1px solid var(--border);
      background: radial-gradient(circle at top, #020617, #020617 55%, #020617 100%);
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .nav-group-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0 10px;
    }
    .nav-list {
      list-style: none;
      padding: 0;
      margin: 4px 0 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 8px;
      font-size: 13px;
      color: var(--muted);
      cursor: pointer;
      transition: background 0.12s, color 0.12s, transform 0.08s;
    }
    .nav-item-icon {
      width: 18px;
      text-align: center;
    }
    .nav-item.active {
      background: linear-gradient(90deg, rgba(59,130,246,0.2), transparent);
      color: #e5e7eb;
    }
    .nav-item:hover {
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      transform: translateX(1px);
    }
    .nav-foot-note {
      margin-top: auto;
      font-size: 11px;
      color: var(--muted);
      padding: 0 10px;
      opacity: 0.7;
    }

    .main {
      padding: 16px 20px 24px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .top-row {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .connection-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px dashed var(--border);
      color: var(--muted);
    }
    .connection-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--yellow);
      box-shadow: 0 0 8px rgba(234,179,8,0.5);
    }
    .module-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }
    .module-tag {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(31,41,55,0.9);
    }
    .control-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .select, .input {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    .select select, .input input {
      background: var(--card);
      border-radius: 6px;
      border: 1px solid rgba(55,65,81,0.8);
      color: var(--text);
      font-size: 12px;
      padding: 4px 8px;
      outline: none;
      min-width: 80px;
    }
    .btn {
      border: none;
      border-radius: 999px;
      font-size: 12px;
      padding: 5px 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.12s, box-shadow 0.12s, transform 0.06s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #22c55e);
      color: white;
      box-shadow: 0 8px 24px rgba(37,99,235,0.45);
    }
    .btn-outline {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
    }
    .btn-outline:hover {
      background: rgba(15,23,42,0.9);
      color: var(--text);
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0,2.2fr) minmax(0,1.6fr);
      gap: 16px;
      align-items: flex-start;
    }
    .card {
      background: radial-gradient(circle at top left, rgba(37,99,235,0.08), transparent),
        radial-gradient(circle at bottom right, rgba(22,163,74,0.06), transparent),
        #020617;
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 14px 14px 12px;
      box-shadow: 0 18px 45px rgba(15,23,42,0.85);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .card-title {
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .card-subtitle {
      font-size: 11px;
      color: var(--muted);
    }
    .pill-soft {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(31,41,55,0.9);
      color: var(--muted);
    }
    .pill-soft.accent {
      border-color: rgba(34,197,94,0.7);
      color: #bbf7d0;
      background: rgba(22,163,74,0.06);
    }

    .metric-row {
      display: flex;
      gap: 12px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    .metric {
      flex: 1;
      min-width: 120px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(31,41,55,0.9);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .metric-label {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .metric-value {
      font-size: 15px;
      font-weight: 600;
    }
    .metric-change {
      font-size: 11px;
    }
    .metric-change.up { color: #4ade80; }
    .metric-pill {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(31,41,55,0.9);
      color: var(--muted);
    }

    .card-body {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }
    .placeholder {
      padding: 10px;
      border-radius: 10px;
      background: rgba(15,23,42,0.9);
      border: 1px dashed rgba(55,65,81,0.8);
      color: var(--muted);
      font-size: 12px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 8px;
    }
    .table th, .table td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      text-align: left;
      white-space: nowrap;
    }
    .table th {
      font-size: 11px;
      color: var(--muted);
      font-weight: 500;
    }
    .table tbody tr:hover {
      background: rgba(15,23,42,0.9);
    }
    .muted { color: var(--muted); }
    .tag-risk-low {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(22,163,74,0.05);
      border: 1px solid rgba(34,197,94,0.4);
      color: #bbf7d0;
      font-size: 11px;
    }
    .tag-risk-med {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(234,179,8,0.05);
      border: 1px solid rgba(234,179,8,0.45);
      color: #fef08a;
      font-size: 11px;
    }

    .footer-meta {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 11px;
      color: var(--muted);
      align-items: center;
      justify-content: space-between;
    }
    .user-id-box {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      padding: 4px 8px;
      border-radius: 6px;
      background: rgba(15,23,42,0.95);
      border: 1px dashed rgba(55,65,81,0.8);
      font-size: 11px;
      color: #e5e7eb;
    }

    @media (max-width: 960px) {
      .layout { grid-template-columns: 60px 1fr; }
      .nav-group-label, .nav-foot-note { display: none; }
      .nav-item span.label { display: none; }
    }
    @media (max-width: 720px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { display: none; }
    }
    @media (max-width: 600px) {
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- Auth Page -->
<div id="authPage" class="auth-wrapper">
  <div class="auth-card">
    <div class="auth-title">
      <div class="auth-logo">â‚¿</div>
      <div class="auth-title-text">é‡‘èç³»çµ±å„€è¡¨æ¿ Pro v4.0</div>
    </div>
    <div class="auth-subtitle">Supabase é›²ç«¯ç™»å…¥ Â· å¤šè¨­å‚™åŒæ­¥</div>
    <div class="auth-badge">
      <span class="auth-cloud-dot"></span>
      é›²ç«¯èªè­‰å•Ÿç”¨
    </div>

    <div id="authMessage" class="auth-msg hidden"></div>

    <form id="loginForm">
      <div class="auth-group">
        <label for="loginEmail">é›»éƒµåœ°å€</label>
        <input id="loginEmail" type="email" class="auth-input" required />
      </div>
      <div class="auth-group">
        <label for="loginPassword">å¯†ç¢¼</label>
        <input id="loginPassword" type="password" class="auth-input" required />
      </div>
      <button id="loginBtn" type="submit" class="auth-btn auth-btn-primary">ç™»å…¥</button>
    </form>

    <form id="signupForm" class="hidden">
      <div class="auth-group">
        <label for="signupEmail">é›»éƒµåœ°å€</label>
        <input id="signupEmail" type="email" class="auth-input" required />
      </div>
      <div class="auth-group">
        <label for="signupPassword">å¯†ç¢¼ï¼ˆè‡³å°‘ 6 ä½ï¼‰</label>
        <input id="signupPassword" type="password" class="auth-input" minlength="6" required />
      </div>
      <div class="auth-group">
        <label for="signupPasswordConfirm">ç¢ºèªå¯†ç¢¼</label>
        <input id="signupPasswordConfirm" type="password" class="auth-input" minlength="6" required />
      </div>
      <button id="signupBtn" type="submit" class="auth-btn auth-btn-primary">è¨»å†Š</button>
    </form>

    <div class="auth-toggle">
      <span id="toggleText">é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ</span>
      <a id="toggleLink">ç«‹å³è¨»å†Š</a>
    </div>
  </div>
</div>

<!-- Dashboard Page (v2.4 UI) -->
<div id="dashboardPage" class="app" style="display:none;">
  <header class="top-bar">
    <div class="title-block">
      <div class="logo">â‚¿</div>
      <div>
        <div class="title-main">é‡‘èç³»çµ±å„€è¡¨æ¿ Pro v2.4</div>
        <div class="title-sub">é›²ç«¯ç‰ˆ Â· 6 å¤§åŠŸèƒ½æ¨¡çµ„ Â· å…¨è¨­å‚™åŒæ­¥ Â· å¯¦æ™‚æ›´æ–°</div>
      </div>
      <div class="badge">
        <span class="cloud-dot"></span>
        é›²ç«¯åŒæ­¥å•Ÿç”¨
      </div>
    </div>

    <div class="user-block">
      <div class="sync-status">
        <span>ç”¨æˆ¶ Emailï¼š<span id="userEmail"></span></span>
        <span class="status">
          <span class="status-dot"></span>
          å·²é€£æ¥ Â· æ‰‹å‹•åŒæ­¥
        </span>
        <button type="button" id="logoutBtn" class="btn btn-outline" style="margin-top:4px;">ç™»å‡º</button>
      </div>
      <div class="avatar"></div>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <div>
        <div class="nav-group-label">ä¸»æ§å°</div>
        <ul class="nav-list">
          <li class="nav-item active">
            <span class="nav-item-icon">ğŸ“Š</span>
            <span class="label">å„€è¡¨æ¿</span>
          </li>
          <li class="nav-item">
            <span class="nav-item-icon">ğŸ“ˆ</span>
            <span class="label">ETF è¿½è¹¤</span>
          </li>
          <li class="nav-item">
            <span class="nav-item-icon">ğŸ’°</span>
            <span class="label">æŠ•è³‡çµ„åˆ</span>
          </li>
          <li class="nav-item">
            <span class="nav-item-icon">âš ï¸</span>
            <span class="label">é¢¨éšªè©•ä¼°</span>
          </li>
          <li class="nav-item">
            <span class="nav-item-icon">ğŸ’µ</span>
            <span class="label">ç¾é‡‘æµ & è¢«å‹•æ”¶å…¥</span>
          </li>
          <li class="nav-item">
            <span class="nav-item-icon">ğŸ“‰</span>
            <span class="label">è¡ç”Ÿå“å·¥å…·</span>
          </li>
        </ul>
      </div>
      <div>
        <div class="nav-group-label">ç³»çµ±</div>
        <ul class="nav-list">
          <li class="nav-item">
            <span class="nav-item-icon">ğŸ”‘</span>
            <span class="label">API é…ç½®</span>
          </li>
          <li class="nav-item">
            <span class="nav-item-icon">âš™ï¸</span>
            <span class="label">ç³»çµ±è¨­ç½®</span>
          </li>
        </ul>
      </div>
      <div class="nav-foot-note">
        v2.4 Â· æœ€è¿‘åŒæ­¥ï¼šæ‰‹å‹• Â· é¦™æ¸¯æ™‚å€
      </div>
    </aside>

    <main class="main">
      <div class="top-row">
        <div>
          <div class="connection-pill">
            <span class="connection-dot"></span>
            å¯¦æ™‚è³‡æ–™ä¸²æµ Â· é€£æ¥ä¸­...
          </div>
          <div class="module-tags">
            <span class="module-tag">å„€è¡¨æ¿</span>
            <span class="module-tag">ETF è¿½è¹¤</span>
            <span class="module-tag">æŠ•è³‡çµ„åˆ</span>
            <span class="module-tag">é¢¨éšªè©•ä¼°</span>
            <span class="module-tag">ç¾é‡‘æµ</span>
            <span class="module-tag">è¡ç”Ÿå“</span>
          </div>
        </div>

        <div class="control-row">
  <div class="select">
    <label for="refresh-interval">åˆ·æ–°é »ç‡:</label>
    <select id="refresh-interval">
      <option value="5m">5 åˆ†é˜</option>
      <option value="15m">15 åˆ†é˜</option>
      <option value="30m">30 åˆ†é˜</option>
      <option value="1h">1 å°æ™‚</option>
      <option value="manual" selected>æ‰‹å‹•</option>
    </select>
  </div>

  <div class="input">
    <label for="tax-rate">ç¨…ç‡ (%):</label>
    <input id="tax-rate" type="number" value="30" min="0" max="100" step="0.1" />
  </div>

  <div class="input">
    <label for="rf-rate">ç„¡é¢¨éšªåˆ©ç‡ (%):</label>
    <input id="rf-rate" type="number" value="2.5" min="0" max="20" step="0.1" />
  </div>

  <button id="btnSaveSettings" class="btn btn-primary">ğŸ’¾ ä¿å­˜è¨­ç½®</button>
  <button id="btnManualSync" class="btn btn-outline">ğŸ”„ æ‰‹å‹•åŒæ­¥</button>
  <button id="btnSaveSnapshot" class="btn btn-outline">ğŸ“¸ ä¿å­˜å¿«ç…§</button>
</div>

      </div>

      <div class="grid">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span>ğŸ“ˆ æŠ•è³‡çµ„åˆç¸½è¦½</span>
                <span class="pill-soft accent">å¤šè³‡ç”¢ Â· å…¨å¸‚å ´</span>
              </div>
              <div class="card-subtitle">
                ç®¡ç†ä½ çš„æŠ•è³‡æŒå€‰ï¼Œè¿½è¹¤æˆæœ¬ã€ç¾å€¼ã€æ”¶ç›Šç‡èˆ‡ ETF è¡¨ç¾ã€‚
              </div>
            </div>
           <button id="btnAddHolding" class="btn btn-outline" style="font-size: 11px; padding-inline: 8px;">
			â• æ–°å¢æŒå€‰
			</button>
          </div>

			<div class="card-body" style="margin-top:10px;">
			<div class="placeholder" id="holdingsEmpty">
				ğŸ“Œ é‚„æ²’æœ‰ä»»ä½•æŒå€‰ã€‚æŒ‰å³ä¸Šè§’ã€Œâ• æ–°å¢æŒå€‰ã€é–‹å§‹å»ºç«‹ä½ çš„æŠ•è³‡çµ„åˆã€‚
			</div>
			
			<div id="holdingsWrap" style="display:none; overflow-x:auto;">
				<table class="table">
				<thead>
					<tr>
					<th>ä»£ç¢¼</th>
					<th>è‚¡æ•¸</th>
					<th>è²·å…¥åƒ¹</th>
					<th>ç¾åƒ¹</th>
					<th>ç¾å€¼</th>
					<th>æ”¶ç›Š</th>
					<th>æ”¶ç›Šç‡</th>
					<th>æ“ä½œ</th>
					</tr>
				</thead>
				<tbody id="holdingsTbody"></tbody>
				</table>
			</div>
			</div>


          <div class="metric-row">
            <div class="metric">
              <div class="metric-label">
                ç¸½è³‡ç”¢
                <span class="metric-pill">å«ç¾é‡‘ & è¡ç”Ÿå“</span>
              </div>
              <div class="metric-value" id="totalAssets">HK$ 0</div>
              <div class="metric-change up">
                â–³ 0.00%ï¼ˆä»Šæ—¥ï¼‰
              </div>
            </div>
            <div class="metric">
              <div class="metric-label">
                å·²å¯¦ç¾ / æœªå¯¦ç¾æ”¶ç›Š
              </div>
              <div class="metric-value" id="totalGain">HK$ 0</div>
              <div class="metric-change muted">
                å·²å¯¦ç¾ï¼š0 Â· æœªå¯¦ç¾ï¼š0
              </div>
            </div>
            <div class="metric">
              <div class="metric-label">
                å¹´åŒ–é æœŸå ±é…¬
              </div>
              <div class="metric-value" id="expectedReturn">0.0%</div>
              <div class="metric-change muted">
                é¢¨éšªèª¿æ•´å¾Œï¼š0.0%ï¼ˆSharpe 0.00ï¼‰
              </div>
            </div>
          </div>

          <div class="card-body">
            <p>ğŸ“Œ é‚„æ²’æœ‰ç›£æ§ä»»ä½• <span class="muted">ETF</span>ã€‚ä½ å¯ä»¥åœ¨ã€ŒETF è¿½è¹¤ã€æ¨¡çµ„ä¸­æ–°å¢ä»£ç¢¼ä»¥é–‹å§‹è¿½è¹¤ 5 å¹´ / 10 å¹´ CAGR èˆ‡åˆ†æ´¾ç´€éŒ„ã€‚</p>
            <div class="placeholder">
              ETF è¿½è¹¤è¡¨ï¼ˆä»£ç¢¼ Â· åç¨± Â· é¡å‹ Â· 5 å¹´ CAGR Â· 10 å¹´ CAGR Â· æè¿° Â· æ“ä½œï¼‰å¯æ”¾åœ¨æ­¤å€å¡Šã€‚  
              ç›®å‰è³‡æ–™ç‚ºç©ºï¼Œå¾…ä½ å¡«å…¥å¯¦éš›æ¸…å–®ã€‚
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span>âš ï¸ é¢¨éšªèˆ‡ç¾é‡‘æµ</span>
                <span class="pill-soft">é¢¨éšªè©•ä¼° Â· è¢«å‹•æ”¶å…¥ Â· è¡ç”Ÿå“</span>
              </div>
              <div class="card-subtitle">
                è©•ä¼°æŠ•è³‡çµ„åˆé¢¨éšªç­‰ç´šã€æ³¢å‹•ç‡ã€å›æ’¤èˆ‡è¢«å‹•æ”¶å…¥è¦†è“‹ç‡ã€‚
              </div>
            </div>
          </div>

          <div class="metric-row">
            <div class="metric">
              <div class="metric-label">
                çµ„åˆé¢¨éšªç­‰ç´š
              </div>
              <div class="metric-value">N/A</div>
              <div class="metric-change muted">
                æ³¢å‹•ç‡ï¼š-- Â· æœ€å¤§å›æ’¤ï¼š--
              </div>
            </div>
            <div class="metric">
              <div class="metric-label">
                é æœŸæœˆåº¦è¢«å‹•æ”¶å…¥
              </div>
              <div class="metric-value">HK$ 0</div>
              <div class="metric-change up">
                ç”Ÿæ´»æ–¹å¼ç­‰åƒ¹ï¼š0 æ¯å’–å•¡ / 0 æ¬¡å¤–å‡ºæ™šé¤
              </div>
            </div>
          </div>

          <div class="card-body">
            <p>å°‡ä½ çš„æœˆåº¦è¢«å‹•æ”¶å…¥è½‰æ›ç‚ºæ—¥å¸¸ç”Ÿæ´»ç­‰åƒ¹æ•¸é‡ï¼Œä¸¦çµåˆè¡ç”Ÿå“ç­–ç•¥ï¼ˆè³£å‡ºçœ‹è·ŒæœŸæ¬Šã€ä¿è­·æ€§è²·æ¬Šï¼‰å„ªåŒ–é¢¨éšª / å ±é…¬çµæ§‹ã€‚</p>

            <div class="placeholder" style="margin-bottom: 8px;">
              è¡ç”Ÿå“è¨ˆç®—æ¨¡çµ„å¯æ”¾ç½®åœ¨æ­¤å€ï¼š  
              - è³£å‡ºçœ‹è·ŒæœŸæ¬Šã€ä¿è­·æ€§è²·æ¬Šæˆæœ¬  
              - æœŸæ¬Šæ”¶ç›Šèˆ‡ä¿è­‰é‡‘éœ€æ±‚  
              - å°æ²–å»ºè­°èˆ‡æƒ…å¢ƒåˆ†æ
            </div>

            <table class="table">
              <thead>
                <tr>
                  <th>ä»£ç¢¼</th>
                  <th>åç¨±</th>
                  <th>å¹´æ”¶ç›Šç‡</th>
                  <th>åˆ†æ´¾é »ç‡</th>
                  <th>é¢¨éšªç­‰ç´š</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>QQQI</td>
                  <td>iShares NASDAQ 100 Covered Call ETF</td>
                  <td>12â€“14%</td>
                  <td>æœˆåº¦</td>
                  <td><span class="tag-risk-med">ä¸­ç­‰</span></td>
                </tr>
                <tr>
                  <td>SPYI</td>
                  <td>S&amp;P 500 Covered Call ETF</td>
                  <td>8â€“10%</td>
                  <td>æœˆåº¦</td>
                  <td><span class="tag-risk-low">ä½</span></td>
                </tr>
                <tr>
                  <td>JEPI</td>
                  <td>JPMorgan Equity Premium Income</td>
                  <td>8â€“10%</td>
                  <td>æœˆåº¦</td>
                  <td><span class="tag-risk-low">ä½</span></td>
                </tr>
                <tr>
                  <td>MO</td>
                  <td>Altria Group Inc</td>
                  <td>8â€“9%</td>
                  <td>å­£åº¦</td>
                  <td><span class="tag-risk-med">ä¸­ç­‰</span></td>
                </tr>
                <tr>
                  <td>O</td>
                  <td>Realty Income Corp</td>
                  <td>3.5â€“4%</td>
                  <td>æœˆåº¦</td>
                  <td><span class="tag-risk-low">ä½</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>

<!-- åœ–è¡¨å€ -->
<div class="grid" style="margin-top:16px;">
  <!-- æŒå€‰é¤…åœ– -->
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">
          <span>ğŸ¥§ æŒå€‰åˆ†ä½ˆ</span>
          <span class="pill-soft">æŒ‰å¸‚å€¼</span>
        </div>
        <div class="card-subtitle">å„ä»£ç¢¼ä½”ç¸½å¸‚å€¼ç™¾åˆ†æ¯”</div>
      </div>
    </div>
    <div class="card-body" style="position:relative; height:280px;">
      <canvas id="chartPie"></canvas>
    </div>
  </section>

  <!-- ç¸½è³‡ç”¢è¶¨å‹¢ -->
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">
          <span>ğŸ“ˆ ç¸½è³‡ç”¢è¶¨å‹¢</span>
          <span class="pill-soft">è¿‘ 30 æ—¥</span>
        </div>
        <div class="card-subtitle">æ¨¡æ“¬æ•¸æ“šï¼ˆå¾…æ¥å…¥çœŸå¯¦æ­·å²å¿«ç…§ï¼‰</div>
      </div>
    </div>
    <div class="card-body" style="position:relative; height:280px;">
      <canvas id="chartLine"></canvas>
    </div>
  </section>
</div>



      <div class="footer-meta">
        <div>
          <span class="muted">ç³»çµ±ç‹€æ…‹ï¼š</span>
          <span>é›²ç«¯åŒæ­¥å·²å•Ÿç”¨ Â· API æœªé…ç½® Â· é¢¨éšªå¼•æ“å¾…åˆå§‹åŒ–</span>
        </div>
        <div class="user-id-box" id="userIdBox">
          user_id: -
        </div>
      </div>
    </main>
  </div>
</div>
		<div id="holdingModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:99999; align-items:center; justify-content:center;">
		<div style="width:92%; max-width:520px; background:#020617; border:1px solid #1f2937; border-radius:14px; padding:16px;">
			<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
			<div id="holdingModalTitle" style="font-weight:600;">æ–°å¢æŒå€‰</div>
			<button id="btnCloseModal" class="btn btn-outline" type="button">âœ•</button>
			</div>

			<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
			<div>
				<div style="font-size:12px; color:#9ca3af; margin-bottom:6px;">ä»£ç¢¼ï¼ˆTickerï¼‰</div>
				<input id="mSymbol" class="auth-input" placeholder="AAPL" />
			</div>
			<div>
				<div style="font-size:12px; color:#9ca3af; margin-bottom:6px;">è‚¡æ•¸</div>
				<input id="mQty" class="auth-input" type="number" step="0.01" placeholder="10" />
			</div>
			<div>
				<div style="font-size:12px; color:#9ca3af; margin-bottom:6px;">è²·å…¥åƒ¹</div>
				<input id="mCost" class="auth-input" type="number" step="0.01" placeholder="150" />
			</div>
			<div>
				<div style="font-size:12px; color:#9ca3af; margin-bottom:6px;">ç¾åƒ¹ï¼ˆæš«ç”¨æ‰‹å¡«ï¼‰</div>
				<input id="mPrice" class="auth-input" type="number" step="0.01" placeholder="160" />
			</div>
			</div>

    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
      <button id="btnSaveHolding" class="btn btn-primary" type="button">ä¿å­˜</button>
      <button id="btnCancelHolding" class="btn btn-outline" type="button">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<script>
console.clear();
console.log('ğŸš€ v4 App start');

// å…¨åŸŸç‹€æ…‹
var app = {
  supabase: null,
  user: null,
  editingHoldingId: null,
  holdingsUIBound: false
};

window.onload = async function () {
  const SUPABASE_URL = 'https://umssuhublguujswugbps.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtc3N1aHVibGd1dWpzd3VnYnBzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4ODQ0MzIsImV4cCI6MjA4MzQ2MDQzMn0.VtRv66cXdbZf0n1qAwFFuSFH4kvuqB0hTgrogNfRD3A'; // â† ä½ åŸæœ¬å—°æ¢ key æ”¾è¿”å…¥åšŸ

  app.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  console.log('âœ… Supabase init');

  bindAuthEvents();

  const { data: { session } } = await app.supabase.auth.getSession();
  if (session) {
    showDashboard(session.user);
  } else {
    showAuth();
  }

  app.supabase.auth.onAuthStateChange(function (event, session) {
    console.log('ğŸ” Auth event:', event);
    if (event === 'SIGNED_IN' && session) {
      showDashboard(session.user);
    } else if (event === 'SIGNED_OUT') {
  // âœ… ä¿éšªï¼šä»»ä½•åŸå› ç™»å‡ºéƒ½åœ timer
  if (app.refreshTimer) {
    clearInterval(app.refreshTimer); // [web:50]
    app.refreshTimer = null;
  }
  showAuth();
}

  });
};

function bindAuthEvents() {
  var loginForm = document.getElementById('loginForm');
  var signupForm = document.getElementById('signupForm');
  var toggleLink = document.getElementById('toggleLink');
  var toggleText = document.getElementById('toggleText');
  var authMessage = document.getElementById('authMessage');
  var loginBtn = document.getElementById('loginBtn');
  var signupBtn = document.getElementById('signupBtn');

  function showMsg(text, type) {
    authMessage.textContent = text;
    authMessage.className = 'auth-msg ' + type;
    authMessage.classList.remove('hidden');
  }
  function hideMsg() {
    authMessage.classList.add('hidden');
  }

  toggleLink.onclick = function () {
    hideMsg();
    if (loginForm.classList.contains('hidden')) {
      loginForm.classList.remove('hidden');
      signupForm.classList.add('hidden');
      toggleText.textContent = 'é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ';
      toggleLink.textContent = 'ç«‹å³è¨»å†Š';
    } else {
      loginForm.classList.add('hidden');
      signupForm.classList.remove('hidden');
      toggleText.textContent = 'å·²æœ‰å¸³è™Ÿï¼Ÿ';
      toggleLink.textContent = 'è¿”å›ç™»å…¥';
    }
  };

  loginForm.onsubmit = async function (e) {
    e.preventDefault();
    hideMsg();

    var email = document.getElementById('loginEmail').value;
    var password = document.getElementById('loginPassword').value;

    loginBtn.disabled = true;
    loginBtn.textContent = 'ç™»å…¥ä¸­...';

    var { error } = await app.supabase.auth.signInWithPassword({ email, password });

    loginBtn.disabled = false;
    loginBtn.textContent = 'ç™»å…¥';

    if (error) showMsg('ç™»å…¥å¤±æ•—ï¼š' + error.message, 'error');
    else showMsg('ç™»å…¥æˆåŠŸï¼', 'success');
  };

  signupForm.onsubmit = async function (e) {
    e.preventDefault();
    hideMsg();

    var email = document.getElementById('signupEmail').value;
    var password = document.getElementById('signupPassword').value;
    var confirm = document.getElementById('signupPasswordConfirm').value;

    if (password !== confirm) {
      showMsg('å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´', 'error');
      return;
    }

    signupBtn.disabled = true;
    signupBtn.textContent = 'è¨»å†Šä¸­...';

    var { error } = await app.supabase.auth.signUp({ email, password });

    signupBtn.disabled = false;
    signupBtn.textContent = 'è¨»å†Š';

    if (error) showMsg('è¨»å†Šå¤±æ•—ï¼š' + error.message, 'error');
    else {
      showMsg('è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥é›»éƒµé©—è­‰ã€‚', 'success');
      signupForm.reset();
    }
  };

document.getElementById('logoutBtn').onclick = async function() {
  if (!confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) return;

  // âœ… åœæ­¢è‡ªå‹•åˆ·æ–°
  if (app.refreshTimer) {
    clearInterval(app.refreshTimer); // [web:50]
    app.refreshTimer = null;
  }

  localStorage.clear();
  sessionStorage.clear();
  await app.supabase.auth.signOut();
};

}

function showAuth() {
  document.getElementById('authPage').style.display = 'flex';
  document.getElementById('dashboardPage').style.display = 'none';
  
   destroyChart('chartPie');
   destroyChart('chartLine');

}

async function showDashboard(user) {
  app.user = user;

  document.getElementById('authPage').style.display = 'none';
  document.getElementById('dashboardPage').style.display = 'grid';
  document.getElementById('userEmail').textContent = user.email;
  document.getElementById('userIdBox').textContent = 'user_id: ' + user.id;

bindSettingsUI();
await loadSettingsAndApply();


  // ç¶å®š holdings UIï¼ˆåªç¶ä¸€æ¬¡ï¼‰
  bindHoldingsUI();

  // å…ˆ render holdings
  await loadHoldingsAndRender();

bindSyncUI();
  applyRefreshInterval(document.getElementById('refresh-interval')?.value || 'manual');
// âœ… ç¶å®šæ‰‹å‹•å¿«ç…§æŒ‰éˆ•
  const btnSnapshot = document.getElementById('btnSaveSnapshot');
  if (btnSnapshot && !btnSnapshot.dataset.bound) {
    btnSnapshot.dataset.bound = '1';
    btnSnapshot.addEventListener('click', saveSnapshotManually);
  }

  // ç™»å…¥æ™‚è‡ªå‹•å­˜å¿«ç…§ï¼ˆå¦‚æœä»Šæ—¥æœªå­˜éï¼‰
  await saveSnapshotIfNeeded();
}

/* =========================
   Holdings (Portfolio) Logic
   ========================= */

// 1) ç¢ºä¿ default portfolio å­˜åœ¨
async function ensureDefaultPortfolio(userId) {
  const { data: existing, error: qErr } = await app.supabase
    .from('portfolios')
    .select('id, portfolio_name')
    .eq('user_id', userId)
    .order('created_at', { ascending: true })
    .limit(1);

  if (qErr) throw qErr;
  if (existing && existing.length > 0) return existing[0].id;

  const { data: created, error: iErr } = await app.supabase
    .from('portfolios')
    .insert([{ user_id: userId, portfolio_name: 'Default Portfolio' }])
    .select('id')
    .single();

  if (iErr) throw iErr;
  return created.id;
}

// 2) è®€å– holdings + æ›´æ–° UI
async function loadHoldingsAndRender() {
  if (!app.user) return;

  const portfolioId = await ensureDefaultPortfolio(app.user.id);

  const { data: rows, error } = await app.supabase
    .from('holdings')
    .select('id, symbol, quantity, cost_price, current_price, current_value, gain, gain_percent')
    .eq('user_id', app.user.id)
    .eq('portfolio_id', portfolioId)
    .order('created_at', { ascending: false });

  if (error) throw error;

  const empty = document.getElementById('holdingsEmpty');
  const wrap = document.getElementById('holdingsWrap');
  const tbody = document.getElementById('holdingsTbody');

  tbody.innerHTML = '';

  if (!rows || rows.length === 0) {
    empty.style.display = 'block';
    wrap.style.display = 'none';
    document.getElementById('totalAssets').textContent = 'HK$ 0';
    document.getElementById('totalGain').textContent = 'HK$ 0';
    return;
  }

  empty.style.display = 'none';
  wrap.style.display = 'block';

  let totalValue = 0;
  let totalGain = 0;

  rows.forEach(r => {
    const qty = Number(r.quantity || 0);
    const cost = Number(r.cost_price || 0);
    const price = Number(r.current_price ?? r.cost_price ?? 0);

    const totalCost = qty * cost;
    const currentValue = (r.current_value != null) ? Number(r.current_value) : qty * price;
    const gain = (r.gain != null) ? Number(r.gain) : (currentValue - totalCost);
    const gainPct = (r.gain_percent != null)
      ? Number(r.gain_percent)
      : (totalCost > 0 ? (gain / totalCost * 100) : 0);

    totalValue += currentValue;
    totalGain += gain;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${(r.symbol || '').toUpperCase()}</strong></td>
      <td>${qty.toFixed(2)}</td>
      <td>${cost.toFixed(2)}</td>
      <td>${price.toFixed(2)}</td>
      <td>${currentValue.toFixed(2)}</td>
      <td style="color:${gain >= 0 ? '#4ade80' : '#ef4444'}"><strong>${gain.toFixed(2)}</strong></td>
      <td style="color:${gainPct >= 0 ? '#4ade80' : '#ef4444'}"><strong>${gainPct.toFixed(2)}%</strong></td>
      <td style="display:flex; gap:6px;">
        <button class="btn btn-outline" type="button"
          data-edit="${r.id}"
          data-symbol="${(r.symbol || '').toUpperCase()}"
          data-qty="${qty}"
          data-cost="${cost}"
          data-price="${price}"
        >ç·¨è¼¯</button>

        <button class="btn btn-outline" type="button" data-del="${r.id}">åˆªé™¤</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('totalAssets').textContent = 'HK$ ' + totalValue.toFixed(2);
  document.getElementById('totalGain').textContent = 'HK$ ' + totalGain.toFixed(2);

  // äº‹ä»¶å§”æ´¾ï¼šåªç¶ä¸€æ¬¡
  if (!tbody.dataset.bound) {
    tbody.dataset.bound = '1';

    tbody.addEventListener('click', async (e) => {
      const editBtn = e.target.closest('button[data-edit]');
      const delBtn = e.target.closest('button[data-del]');

      if (editBtn) {
        openHoldingModalForEdit({
          id: editBtn.dataset.edit,
          symbol: editBtn.dataset.symbol,
          quantity: editBtn.dataset.qty,
          cost_price: editBtn.dataset.cost,
          current_price: editBtn.dataset.price
        });
        return;
      }

      if (delBtn) {
        const id = delBtn.dataset.del;
        if (!confirm('ç¢ºå®šåˆªé™¤é€™ç­†æŒå€‰ï¼Ÿ')) return;
        await deleteHolding(id);
        await loadHoldingsAndRender();
      }
    });
  }
  renderCharts(); // âœ… æ¯æ¬¡é‡æ–° render holdings éƒ½åŒæ­¥æ›´æ–°åœ–è¡¨
  // âœ… æ¯æ¬¡æ›´æ–° holdings å¾Œï¼Œæ›´æ–°ä»Šæ—¥å¿«ç…§ï¼ˆå¦‚æœå·²å­˜åœ¨å°±è¦†è“‹ï¼‰



}

// 3) æ–°å¢æŒå€‰
async function createHoldingFromModal() {
  try {
    const symbol = document.getElementById('mSymbol').value.trim().toUpperCase();
    const addQty = Number(document.getElementById('mQty').value);
    const addCost = Number(document.getElementById('mCost').value);
    const currentPrice = Number(document.getElementById('mPrice').value);

    if (!app.user || !app.user.id) {
      alert('âŒ ç”¨æˆ¶æœªç™»å…¥');
      return;
    }
    if (!symbol || !Number.isFinite(addQty) || addQty <= 0 || !Number.isFinite(addCost) || addCost <= 0 || !Number.isFinite(currentPrice) || currentPrice <= 0) {
      alert('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„ä»£ç¢¼/è‚¡æ•¸/è²·å…¥åƒ¹/ç¾åƒ¹ï¼ˆéƒ½è¦ > 0ï¼‰');
      return;
    }

    const portfolioId = await ensureDefaultPortfolio(app.user.id);

    // 1) å…ˆæŸ¥æœ‰å†‡åŒ tickerï¼ˆåŒä¸€ portfolioï¼‰
    const { data: existingRows, error: qErr } = await app.supabase
      .from('holdings')
      .select('id, quantity, cost_price')
      .eq('user_id', app.user.id)
      .eq('portfolio_id', portfolioId)
      .eq('symbol', symbol)
      .limit(1);

    if (qErr) throw qErr;

    const purchaseDate = new Date().toISOString().slice(0, 10);

    // 2) å¦‚æœå­˜åœ¨ â†’ åŠ å€‰ï¼ˆupdateï¼‰
    if (existingRows && existingRows.length > 0) {
      const row = existingRows[0];

      const oldQty = Number(row.quantity || 0);
      const oldCost = Number(row.cost_price || 0);

      const newQty = oldQty + addQty;

      // åŠ æ¬Šå¹³å‡æˆæœ¬
      const newCost =
        newQty > 0 ? ((oldQty * oldCost) + (addQty * addCost)) / newQty : addCost;

      const totalCost = newQty * newCost;
      const currentValue = newQty * currentPrice;
      const gain = currentValue - totalCost;
      const gainPercent = totalCost > 0 ? (gain / totalCost * 100) : 0;

      const { error: uErr } = await app.supabase
        .from('holdings')
        .update({
          quantity: newQty,
          cost_price: newCost,
          current_price: currentPrice,
          current_value: currentValue,
          gain: gain,
          gain_percent: gainPercent,
          purchase_date: purchaseDate
        })
        .eq('id', row.id)
        .eq('user_id', app.user.id);

      if (uErr) throw uErr;

      return; // âœ… çµæŸ
    }

    // 3) å¦‚æœä¸å­˜åœ¨ â†’ æ–°å¢ï¼ˆinsertï¼‰
    const totalCost = addQty * addCost;
    const currentValue = addQty * currentPrice;
    const gain = currentValue - totalCost;
    const gainPercent = totalCost > 0 ? (gain / totalCost * 100) : 0;

    const { error: iErr } = await app.supabase
      .from('holdings')
      .insert([{
        user_id: app.user.id,
        portfolio_id: portfolioId,
        symbol: symbol,
        quantity: addQty,
        cost_price: addCost,
        purchase_date: purchaseDate,
        current_price: currentPrice,
        current_value: currentValue,
        gain: gain,
        gain_percent: gainPercent
      }]);

    if (iErr) throw iErr;

  } catch (e) {
    console.error('createHoldingFromModal error:', e);
    alert('æ–°å¢/åŠ å€‰å¤±æ•—ï¼š' + (e.message || e));
  }
}


// 4) ç·¨è¼¯ï¼šé–‹çª— + å¡«å€¼
function openHoldingModalForEdit(row) {
  app.editingHoldingId = row.id;

  const titleEl = document.getElementById('holdingModalTitle');
  const saveBtn = document.getElementById('btnSaveHolding');
  if (titleEl) titleEl.textContent = 'ç·¨è¼¯æŒå€‰';
  if (saveBtn) saveBtn.textContent = 'æ›´æ–°';

  document.getElementById('mSymbol').value = (row.symbol || '').toUpperCase();
  document.getElementById('mQty').value = Number(row.quantity) || 0;
  document.getElementById('mCost').value = Number(row.cost_price) || 0;
  document.getElementById('mPrice').value = Number(row.current_price ?? row.cost_price ?? 0);

  openHoldingModal();
}

// 5) æ›´æ–°æŒå€‰
async function updateHoldingFromModal() {
  if (!app.editingHoldingId) throw new Error('editingHoldingId missing');

  const symbol = document.getElementById('mSymbol').value.trim().toUpperCase();
  const quantity = Number(document.getElementById('mQty').value);
  const cost_price = Number(document.getElementById('mCost').value);
  const current_price = Number(document.getElementById('mPrice').value);

  if (!symbol || !Number.isFinite(quantity) || !Number.isFinite(cost_price) || !Number.isFinite(current_price)) {
    alert('âŒ è«‹è¼¸å…¥å®Œæ•´ä¸”æœ‰æ•ˆçš„æ•¸å€¼');
    return;
  }

  const total_cost = quantity * cost_price;
  const current_value = quantity * current_price;
  const gain = current_value - total_cost;
  const gain_percent = total_cost > 0 ? (gain / total_cost * 100) : 0;

  const { error } = await app.supabase
    .from('holdings')
    .update({
      symbol,
      quantity,
      cost_price,
      current_price,
      current_value,
      gain,
      gain_percent
    })
    .eq('id', app.editingHoldingId)
    .eq('user_id', app.user.id);

  if (error) throw error;

  app.editingHoldingId = null;
}

// 6) åˆªé™¤æŒå€‰
async function deleteHolding(id) {
  const { error } = await app.supabase
    .from('holdings')
    .delete()
    .eq('id', id)
    .eq('user_id', app.user.id);

  if (error) throw error;
}

/* =========================
   Modal + UI Binding
   ========================= */

function openHoldingModal() {
  document.getElementById('holdingModal').style.display = 'flex';
}

function openHoldingModalForAdd() {
  app.editingHoldingId = null;

  const titleEl = document.getElementById('holdingModalTitle');
  const saveBtn = document.getElementById('btnSaveHolding');
  if (titleEl) titleEl.textContent = 'æ–°å¢æŒå€‰';
  if (saveBtn) saveBtn.textContent = 'ä¿å­˜';

  document.getElementById('mSymbol').value = '';
  document.getElementById('mQty').value = '';
  document.getElementById('mCost').value = '';
  document.getElementById('mPrice').value = '';

  openHoldingModal();
}

function closeHoldingModal() {
  document.getElementById('holdingModal').style.display = 'none';
  document.getElementById('mSymbol').value = '';
  document.getElementById('mQty').value = '';
  document.getElementById('mCost').value = '';
  document.getElementById('mPrice').value = '';
  app.editingHoldingId = null;
}

function bindHoldingsUI() {
  if (app.holdingsUIBound) return; // âœ… é˜²æ­¢é‡è¤‡ç¶å®š
  app.holdingsUIBound = true;

  const btnAdd = document.getElementById('btnAddHolding');
  const btnClose = document.getElementById('btnCloseModal');
  const btnCancel = document.getElementById('btnCancelHolding');
  const btnSave = document.getElementById('btnSaveHolding');

  if (btnAdd) btnAdd.addEventListener('click', openHoldingModalForAdd);
  if (btnClose) btnClose.addEventListener('click', closeHoldingModal);
  if (btnCancel) btnCancel.addEventListener('click', closeHoldingModal);

  if (btnSave) {
    btnSave.addEventListener('click', async () => {
      try {
        btnSave.disabled = true;

        if (app.editingHoldingId) {
          await updateHoldingFromModal();
        } else {
          await createHoldingFromModal();
        }

        closeHoldingModal();
        await loadHoldingsAndRender();
      } catch (e) {
        console.error('Save error:', e);
        alert('ä¿å­˜å¤±æ•—ï¼š' + (e.message || e));
      } finally {
        btnSave.disabled = false;
      }
    });
  }
  
}
function bindSettingsUI() {
  const btn = document.getElementById('btnSaveSettings');
  if (!btn || btn.dataset.bound) return;
  btn.dataset.bound = '1';

  btn.addEventListener('click', async () => {
    try {
      if (!app.user) return alert('âŒ æœªç™»å…¥');

      btn.disabled = true;
      btn.textContent = 'ä¿å­˜ä¸­...';

      const taxRate = Number(document.getElementById('tax-rate').value);
      const rfRate = Number(document.getElementById('rf-rate').value);
      const refreshInterval = document.getElementById('refresh-interval')?.value || 'manual';

      if (!Number.isFinite(taxRate) || taxRate < 0 || taxRate > 100) {
        alert('âŒ ç¨…ç‡è¦ 0-100');
        return;
      }
      if (!Number.isFinite(rfRate) || rfRate < 0 || rfRate > 100) {
        alert('âŒ ç„¡é¢¨éšªåˆ©ç‡è¦åˆç†æ•¸å€¼');
        return;
      }

      const payload = {
        user_id: app.user.id,
        tax_rate: taxRate,
        rf_rate: rfRate,
        refresh_interval: refreshInterval,
        currency: 'HKD',
        updated_at: new Date().toISOString()
      };

      const { error } = await app.supabase
        .from('settings')
        .upsert(payload, { onConflict: 'user_id' }); // ä¾ user_id å­˜/æ›´æ–° [web:35]

      if (error) throw error;

      alert('âœ… è¨­ç½®å·²ä¿å­˜');
    } catch (e) {
      console.error('save settings error:', e);
      alert('ä¿å­˜å¤±æ•—ï¼š' + (e.message || e));
    } finally {
      btn.disabled = false;
      btn.textContent = 'ğŸ’¾ ä¿å­˜è¨­ç½®';
    }
  });
}

async function loadSettingsAndApply() {
  if (!app.user) return;

  const { data, error } = await app.supabase
    .from('settings')
    .select('tax_rate, rf_rate, refresh_interval, currency')
    .eq('user_id', app.user.id)
    .maybeSingle();

  if (error) {
    console.error('load settings error:', error);
    return;
  }

  // ç„¡è³‡æ–™å°±ç”¨é è¨­
  document.getElementById('tax-rate').value = (data?.tax_rate ?? 30);
  document.getElementById('rf-rate').value = (data?.rf_rate ?? 2.5);

  const sel = document.getElementById('refresh-interval');
  if (sel) sel.value = (data?.refresh_interval ?? 'manual');
}
// ===== Refresh + Manual Sync =====
app.refreshTimer = null;

function parseRefreshIntervalToMs(v) {
  if (!v || v === 'manual') return null;
  if (v === '5m') return 5 * 60 * 1000;
  if (v === '15m') return 15 * 60 * 1000;
  if (v === '30m') return 30 * 60 * 1000;
  if (v === '1h') return 60 * 60 * 1000;
  return null;
}

function applyRefreshInterval(v) {
  // å…ˆæ¸…æ‰èˆŠ timerï¼ˆè½‰é »ç‡/ç™»å‡º/é‡ç™»å…¥éƒ½å®‰å…¨ï¼‰
  if (app.refreshTimer) {
    clearInterval(app.refreshTimer); // æ¸…é™¤ç”± setInterval å»ºç«‹å˜…é‡è¤‡ä»»å‹™ [web:50]
    app.refreshTimer = null;
  }

  const ms = parseRefreshIntervalToMs(v);
  if (!ms) return;

  // ç«‹å³è·‘ä¸€æ¬¡ï¼Œä¹‹å¾ŒæŒ‰é »ç‡è·‘
  safeSyncOnce('auto');

  app.refreshTimer = setInterval(() => {
    safeSyncOnce('auto');
  }, ms); // setInterval æœƒå›å‚³ intervalIDï¼Œä¹‹å¾Œç”¨ clearInterval å–æ¶ˆ [web:53]
}

async function safeSyncOnce(mode) {
  if (!app.user) return;

  const btn = document.getElementById('btnManualSync');
  try {
    if (btn && mode === 'manual') {
      btn.disabled = true;
      btn.textContent = 'åŒæ­¥ä¸­...';
    }

    await loadHoldingsAndRender();

    // ç”¨æŒ‰éˆ•æ–‡å­—é¡¯ç¤ºæœ€å¾ŒåŒæ­¥æ™‚é–“ï¼ˆå””æ´—æ”¹ UIï¼‰
    const t = new Date();
    const hh = String(t.getHours()).padStart(2, '0');
    const mm = String(t.getMinutes()).padStart(2, '0');
    const ss = String(t.getSeconds()).padStart(2, '0');
    if (btn) btn.textContent = `ğŸ”„ æ‰‹å‹•åŒæ­¥ï¼ˆ${hh}:${mm}:${ss}ï¼‰`;
  } catch (e) {
    console.error('sync error:', e);
    alert('åŒæ­¥å¤±æ•—ï¼š' + (e.message || e));
    if (btn) btn.textContent = 'ğŸ”„ æ‰‹å‹•åŒæ­¥';
  } finally {
    if (btn) btn.disabled = false;
  }
}

function bindSyncUI() {
  const sel = document.getElementById('refresh-interval');
  const btn = document.getElementById('btnManualSync');

  if (sel && !sel.dataset.bound) {
    sel.dataset.bound = '1';
    sel.addEventListener('change', async () => {
      const newVal = sel.value;
      
      // 1) å³åˆ»å¥—ç”¨æ–°é »ç‡
      applyRefreshInterval(newVal);

      // 2) è‡ªå‹•å¯«å› DBï¼ˆå…æŒ‰ä¿å­˜ï¼‰
      if (app.user) {
        try {
          const { error } = await app.supabase
            .from('settings')
            .upsert({
              user_id: app.user.id,
              refresh_interval: newVal,
              updated_at: new Date().toISOString()
            }, { onConflict: 'user_id' });

          if (error) throw error;

          console.log('âœ… refresh_interval å·²è‡ªå‹•ä¿å­˜:', newVal);
        } catch (e) {
          console.error('è‡ªå‹•ä¿å­˜ refresh_interval å¤±æ•—:', e);
          // å”” alert ç”¨æˆ¶ï¼Œéœéœè¨˜ log å°±å¥½ï¼ˆå› ç‚ºä½¢åªä¿‚æ”¹å€‹ dropdownï¼‰
        }
      }
    });
  }

  if (btn && !btn.dataset.bound) {
    btn.dataset.bound = '1';
    btn.addEventListener('click', () => safeSyncOnce('manual'));
  }
}

// ===== Charts =====
app.chartPie = null;
app.chartLine = null;

function renderCharts() {
  renderPieChart();
  renderLineChart();
}

async function renderPieChart() {
  if (!app.user) return;

  const portfolioId = await ensureDefaultPortfolio(app.user.id);

  const { data: rows } = await app.supabase
  .from('holdings')
  .select('symbol, current_value')
  .eq('user_id', app.user.id)
  .eq('portfolio_id', portfolioId);


  if (!rows || rows.length === 0) {
    destroyChart('chartPie');
    return;
  }

  const labels = [];
  const data = [];
  const colors = [
    '#3b82f6', '#22c55e', '#eab308', '#ef4444', '#8b5cf6',
    '#ec4899', '#06b6d4', '#f97316', '#10b981', '#6366f1'
  ];

  rows.forEach(r => {
    labels.push((r.symbol || '').toUpperCase());
    data.push(Number(r.current_value || 0));
  });

  const ctx = document.getElementById('chartPie');
  if (!ctx) return;

  destroyChart('chartPie');

  app.chartPie = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: colors.slice(0, labels.length),
        borderColor: '#020617',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: { color: '#e5e7eb', font: { size: 11 } }
        },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const label = ctx.label || '';
              const value = ctx.parsed || 0;
              const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
              const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
              return `${label}: HK$ ${value.toFixed(2)} (${pct}%)`;
            }
          }
        }
      }
    }
  });
}

async function renderLineChart() {
  if (!app.user) return;

  try {
    const portfolioId = await ensureDefaultPortfolio(app.user.id);

    // è®€å–æœ€è¿‘ 30 æ—¥å¿«ç…§
    const { data: snapshots } = await app.supabase
      .from('portfolio_snapshots')
      .select('snapshot_date, total_value')
      .eq('user_id', app.user.id)
      .eq('portfolio_id', portfolioId)
      .order('snapshot_date', { ascending: true })
      .limit(30);

    const labels = [];
    const data = [];

    if (!snapshots || snapshots.length === 0) {
      // å¦‚æœå†‡æ­·å²æ•¸æ“šï¼Œç”¨æ¨¡æ“¬æ•¸æ“šï¼ˆ30 æ—¥ï¼‰
      const today = new Date();
      const totalAssetsText = document.getElementById('totalAssets')?.textContent || 'HK$ 0';
      const totalAssets = Number(totalAssetsText.replace(/[^\d.-]/g, '')) || 10000;

      for (let i = 29; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        labels.push(`${d.getMonth() + 1}/${d.getDate()}`);
        
        const variation = (Math.random() - 0.5) * 0.06;
        const val = totalAssets * (1 + variation * (i / 30));
        data.push(val);
      }
      data[data.length - 1] = totalAssets;
    } else {
      // ä½¿ç”¨çœŸå¯¦å¿«ç…§æ•¸æ“š
      snapshots.forEach(s => {
        const d = new Date(s.snapshot_date);
        labels.push(`${d.getMonth() + 1}/${d.getDate()}`);
        data.push(Number(s.total_value || 0));
      });
    }

    const ctx = document.getElementById('chartLine');
    if (!ctx) return;

    destroyChart('chartLine');

    app.chartLine = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'ç¸½è³‡ç”¢ (HK$)',
          data: data,
          borderColor: '#22c55e',
          backgroundColor: 'rgba(34, 197, 94, 0.1)',
          borderWidth: 2,
          tension: 0.3,
          fill: true,
          pointRadius: 2,
          pointHoverRadius: 5,
          pointBackgroundColor: '#22c55e'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
            mode: 'index',
            intersect: false,
            callbacks: {
              label: function(ctx) {
                return `ç¸½è³‡ç”¢: HK$ ${ctx.parsed.y.toFixed(2)}`;
              }
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#9ca3af', font: { size: 10 } },
            grid: { color: '#1f2937' }
          },
          y: {
            ticks: {
              color: '#9ca3af',
              font: { size: 10 },
              callback: function(value) {
                return 'HK$ ' + value.toLocaleString();
              }
            },
            grid: { color: '#1f2937' }
          }
        }
      }
    });
  } catch (e) {
    console.error('renderLineChart error:', e);
  }
}


function destroyChart(id) {
  if (id === 'chartPie' && app.chartPie) {
    app.chartPie.destroy();
    app.chartPie = null;
  }
  if (id === 'chartLine' && app.chartLine) {
    app.chartLine.destroy();
    app.chartLine = null;
  }
}
// ===== Charts =====
app.chartPie = null;
app.chartLine = null;

function renderCharts() {
  renderPieChart();
  renderLineChart();
}

// ===== Portfolio Snapshots =====
async function saveSnapshotIfNeeded() {
  if (!app.user) return;

  try {
    const portfolioId = await ensureDefaultPortfolio(app.user.id);
    const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

    // æª¢æŸ¥ä»Šæ—¥æœ‰å†‡å¿«ç…§
    const { data: existing } = await app.supabase
      .from('portfolio_snapshots')
      .select('id')
      .eq('user_id', app.user.id)
      .eq('portfolio_id', portfolioId)
      .eq('snapshot_date', today)
      .maybeSingle();

    if (existing) {
      console.log('âœ… ä»Šæ—¥å¿«ç…§å·²å­˜åœ¨ï¼Œå””é‡è¤‡ä¿å­˜');
      return; // å·²ç¶“æœ‰ï¼Œå””é‡è¤‡å­˜
    }

    // è¨ˆç®—ç•¶å‰ç¸½è³‡ç”¢ / ç¸½æ”¶ç›Š
    const { data: rows } = await app.supabase
      .from('holdings')
      .select('current_value, gain')
      .eq('user_id', app.user.id)
      .eq('portfolio_id', portfolioId);

    let totalValue = 0;
    let totalGain = 0;

    if (rows && rows.length > 0) {
      rows.forEach(r => {
        totalValue += Number(r.current_value || 0);
        totalGain += Number(r.gain || 0);
      });
    }

    const totalCost = totalValue - totalGain;
    const totalGainPercent = totalCost > 0 ? (totalGain / totalCost * 100) : 0;

    // å„²å­˜å¿«ç…§
    const { error } = await app.supabase
      .from('portfolio_snapshots')
      .insert([{
        user_id: app.user.id,
        portfolio_id: portfolioId,
        snapshot_date: today,
        total_value: totalValue,
        total_gain: totalGain,
        total_gain_percent: totalGainPercent,
        holdings_count: rows ? rows.length : 0
      }]);

    if (error) throw error;

    console.log('ğŸ’¾ å¿«ç…§å·²ä¿å­˜:', { date: today, totalValue, totalGain });
  } catch (e) {
    console.error('ä¿å­˜å¿«ç…§å¤±æ•—:', e);
  }
  
  
}

async function saveSnapshotManually() {
  if (!app.user) return alert('âŒ æœªç™»å…¥');

  const btn = document.getElementById('btnSaveSnapshot');
  
  try {
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'ä¿å­˜ä¸­...';
    }

    const portfolioId = await ensureDefaultPortfolio(app.user.id);
    const today = new Date().toISOString().slice(0, 10);

    // è¨ˆç®—ç•¶å‰ç¸½è³‡ç”¢ / ç¸½æ”¶ç›Š
    const { data: rows } = await app.supabase
      .from('holdings')
      .select('current_value, gain')
      .eq('user_id', app.user.id)
      .eq('portfolio_id', portfolioId);

    let totalValue = 0;
    let totalGain = 0;

    if (rows && rows.length > 0) {
      rows.forEach(r => {
        totalValue += Number(r.current_value || 0);
        totalGain += Number(r.gain || 0);
      });
    }

    const totalCost = totalValue - totalGain;
    const totalGainPercent = totalCost > 0 ? (totalGain / totalCost * 100) : 0;

    // ç”¨ upsertï¼ˆå¦‚æœä»Šæ—¥å·²å­˜åœ¨å°±è¦†è“‹ï¼‰
    const { error } = await app.supabase
      .from('portfolio_snapshots')
      .upsert({
        user_id: app.user.id,
        portfolio_id: portfolioId,
        snapshot_date: today,
        total_value: totalValue,
        total_gain: totalGain,
        total_gain_percent: totalGainPercent,
        holdings_count: rows ? rows.length : 0
      }, {
        onConflict: 'user_id,portfolio_id,snapshot_date'
      });

    if (error) throw error;

    console.log('ğŸ“¸ æ‰‹å‹•å¿«ç…§å·²ä¿å­˜:', { date: today, totalValue });
    alert('âœ… å¿«ç…§å·²ä¿å­˜ï¼');

    // åˆ·æ–°è¶¨å‹¢åœ–
    await renderLineChart();

  } catch (e) {
    console.error('æ‰‹å‹•ä¿å­˜å¿«ç…§å¤±æ•—:', e);
    alert('ä¿å­˜å¤±æ•—ï¼š' + (e.message || e));
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'ğŸ“¸ ä¿å­˜å¿«ç…§';
    }
  }
}


async function renderPieChart() {
  if (!app.user) return;

  const portfolioId = await ensureDefaultPortfolio(app.user.id);

  const { data: rows } = await app.supabase
  .from('holdings')
  .select('symbol, current_value')
  .eq('user_id', app.user.id)
  .eq('portfolio_id', portfolioId);



  if (!rows || rows.length === 0) {
    destroyChart('chartPie');
    return;
  }

  const labels = [];
  const data = [];
  const colors = [
    '#3b82f6', '#22c55e', '#eab308', '#ef4444', '#8b5cf6',
    '#ec4899', '#06b6d4', '#f97316', '#10b981', '#6366f1'
  ];

  rows.forEach(r => {
    labels.push((r.symbol || '').toUpperCase());
   data.push(Number(r.current_value || 0));
  });

  const ctx = document.getElementById('chartPie');
  if (!ctx) return;

  destroyChart('chartPie');

  app.chartPie = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: colors.slice(0, labels.length),
        borderColor: '#020617',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: { color: '#e5e7eb', font: { size: 11 } }
        },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const label = ctx.label || '';
              const value = ctx.parsed || 0;
              const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
              const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
              return `${label}: HK$ ${value.toFixed(2)} (${pct}%)`;
            }
          }
        }
      }
    }
  });
}

function renderLineChart() {
  const labels = [];
  const data = [];
  const today = new Date();

  const totalAssetsText = document.getElementById('totalAssets')?.textContent || 'HK$ 0';
  const totalAssets = Number(totalAssetsText.replace(/[^\d.-]/g, '')) || 10000;

  for (let i = 29; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    labels.push(`${d.getMonth() + 1}/${d.getDate()}`);

    const variation = (Math.random() - 0.5) * 0.06;
    const val = totalAssets * (1 + variation * (i / 30));
    data.push(val);
  }

  data[data.length - 1] = totalAssets;

  const ctx = document.getElementById('chartLine');
  if (!ctx) return;

  destroyChart('chartLine');

  app.chartLine = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'ç¸½è³‡ç”¢ (HK$)',
        data: data,
        borderColor: '#22c55e',
        backgroundColor: 'rgba(34, 197, 94, 0.1)',
        borderWidth: 2,
        tension: 0.3,
        fill: true,
        pointRadius: 0,
        pointHoverRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: {
            label: function(ctx) {
              return `ç¸½è³‡ç”¢: HK$ ${ctx.parsed.y.toFixed(2)}`;
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { color: '#9ca3af', font: { size: 10 } },
          grid: { color: '#1f2937' }
        },
        y: {
          ticks: {
            color: '#9ca3af',
            font: { size: 10 },
            callback: function(value) {
              return 'HK$ ' + value.toLocaleString();
            }
          },
          grid: { color: '#1f2937' }
        }
      }
    }
  });
}

function destroyChart(id) {
  if (id === 'chartPie' && app.chartPie) {
    app.chartPie.destroy();
    app.chartPie = null;
  }
  if (id === 'chartLine' && app.chartLine) {
    app.chartLine.destroy();
    app.chartLine = null;
  }
}


</script>
</body>
</html>
