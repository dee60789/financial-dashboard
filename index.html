<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>é‡‘èç³»çµ±å„€è¡¨æ¿ Pro v4.0 - Supabase é›²ç«¯ç‰ˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #020617;
      --bg-alt: #020617;
      --card: #0b1120;
      --card-soft: #111827;
      --primary: #3b82f6;
      --accent: #22c55e;
      --danger: #ef4444;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border: #1f2937;
      --yellow: #eab308;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
    }

    a { color: var(--primary); text-decoration: none; }

    /* ===== Auth é  ===== */
    .auth-wrapper {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, #020617 0, #020617 55%, #000 100%);
    }
    .auth-card {
      width: 100%;
      max-width: 420px;
      background: #020617;
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 32px 28px 28px;
      box-shadow: 0 24px 80px rgba(0,0,0,0.8);
    }
    .auth-title {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 6px;
    }
    .auth-logo {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: radial-gradient(circle at 20% 20%, #22c55e, #0ea5e9 45%, #1d4ed8 80%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .auth-title-text {
      font-size: 18px;
      font-weight: 600;
    }
    .auth-subtitle {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 20px;
    }
    .auth-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 18px;
    }
    .auth-cloud-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }
    .auth-group { margin-bottom: 16px; }
    .auth-group label {
      display: block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .auth-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #020617;
      color: var(--text);
      font-size: 13px;
      outline: none;
    }
    .auth-input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(59,130,246,0.5);
    }
    .auth-btn {
      width: 100%;
      border-radius: 999px;
      border: none;
      padding: 10px 0;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 4px;
    }
    .auth-btn-primary {
      background: linear-gradient(135deg, #2563eb, #22c55e);
      color: #fff;
      box-shadow: 0 10px 30px rgba(37,99,235,0.6);
    }
    .auth-btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .auth-toggle {
      margin-top: 12px;
      font-size: 13px;
      color: var(--muted);
      text-align: center;
    }
    .auth-toggle a { cursor: pointer; }
    .auth-msg {
      font-size: 12px;
      margin-bottom: 12px;
      padding: 8px 10px;
      border-radius: 8px;
    }
    .auth-msg.error {
      border: 1px solid var(--danger);
      color: var(--danger);
      background: rgba(239,68,68,0.1);
    }
    .auth-msg.success {
      border: 1px solid var(--accent);
      color: var(--accent);
      background: rgba(34,197,94,0.08);
    }
    .hidden { display: none; }

    /* ===== v2.4 å„€è¡¨æ¿ Layout ===== */
    .app {
      min-height: 100vh;
      display: grid;
      grid-template-rows: auto 1fr;
      background: linear-gradient(135deg, #020617 0, #020617 40%, #020617 100%);
    }
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      background: rgba(15,23,42,0.95);
      backdrop-filter: blur(16px);
      position: sticky;
      top: 0;
      z-index: 20;
    }
    .title-block {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo {
      width: 32px;
      height: 32px;
      border-radius: 10px;
      background: radial-gradient(circle at 20% 20%, #22c55e, #0ea5e9 45%, #1d4ed8 80%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    .title-main { font-weight: 600; }
    .title-sub { font-size: 12px; color: var(--muted); }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 11px;
      color: var(--muted);
    }
    .cloud-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 8px var(--accent);
    }
    .user-block {
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .sync-status {
      font-size: 12px;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }
    .sync-status span.status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(34,197,94,0.4);
      color: #bbf7d0;
      background: rgba(22,163,74,0.08);
    }
    .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }
    .avatar {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0, #fbbf24, #f97316 60%, #9f1239);
      border: 1px solid rgba(148,163,184,0.3);
    }

    .layout {
      display: grid;
      grid-template-columns: 220px 1fr;
      min-height: 0;
      height: calc(100vh - 56px);
    }
    .sidebar {
      border-right: 1px solid var(--border);
      background: radial-gradient(circle at top, #020617, #020617 55%, #020617 100%);
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .nav-group-label {
      font-size: 11px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0 10px;
    }
    .nav-list {
      list-style: none;
      padding: 0;
      margin: 4px 0 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 8px;
      font-size: 13px;
      color: var(--muted);
      cursor: pointer;
      transition: background 0.12s, color 0.12s, transform 0.08s;
    }
    .nav-item-icon {
      width: 18px;
      text-align: center;
    }
    .nav-item.active {
      background: linear-gradient(90deg, rgba(59,130,246,0.2), transparent);
      color: #e5e7eb;
    }
    .nav-item:hover {
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      transform: translateX(1px);
    }
    .nav-foot-note {
      margin-top: auto;
      font-size: 11px;
      color: var(--muted);
      padding: 0 10px;
      opacity: 0.7;
    }

    .main {
      padding: 16px 20px 24px;
      overflow: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    .top-row {
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    .connection-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px dashed var(--border);
      color: var(--muted);
    }
    .connection-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--yellow);
      box-shadow: 0 0 8px rgba(234,179,8,0.5);
    }
    .module-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }
    .module-tag {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(31,41,55,0.9);
    }
    .control-row {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .select, .input {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
    }
    .select select, .input input {
      background: var(--card);
      border-radius: 6px;
      border: 1px solid rgba(55,65,81,0.8);
      color: var(--text);
      font-size: 12px;
      padding: 4px 8px;
      outline: none;
      min-width: 80px;
    }
    .btn {
      border: none;
      border-radius: 999px;
      font-size: 12px;
      padding: 5px 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.12s, box-shadow 0.12s, transform 0.06s;
    }
    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #22c55e);
      color: white;
      box-shadow: 0 8px 24px rgba(37,99,235,0.45);
    }
    .btn-outline {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
    }
    .btn-outline:hover {
      background: rgba(15,23,42,0.9);
      color: var(--text);
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(0,2.2fr) minmax(0,1.6fr);
      gap: 16px;
      align-items: flex-start;
    }
    .card {
      background: radial-gradient(circle at top left, rgba(37,99,235,0.08), transparent),
        radial-gradient(circle at bottom right, rgba(22,163,74,0.06), transparent),
        #020617;
      border-radius: 14px;
      border: 1px solid var(--border);
      padding: 14px 14px 12px;
      box-shadow: 0 18px 45px rgba(15,23,42,0.85);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    .card-title {
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .card-subtitle {
      font-size: 11px;
      color: var(--muted);
    }
    .pill-soft {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(31,41,55,0.9);
      color: var(--muted);
    }
    .pill-soft.accent {
      border-color: rgba(34,197,94,0.7);
      color: #bbf7d0;
      background: rgba(22,163,74,0.06);
    }

    .metric-row {
      display: flex;
      gap: 12px;
      margin-bottom: 6px;
      flex-wrap: wrap;
    }
    .metric {
      flex: 1;
      min-width: 120px;
      padding: 8px 10px;
      border-radius: 10px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(31,41,55,0.9);
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .metric-label {
      font-size: 11px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .metric-value {
      font-size: 15px;
      font-weight: 600;
    }
    .metric-change {
      font-size: 11px;
    }
    .metric-change.up { color: #4ade80; }
    .metric-pill {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(31,41,55,0.9);
      color: var(--muted);
    }

    .card-body {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }
    .placeholder {
      padding: 10px;
      border-radius: 10px;
      background: rgba(15,23,42,0.9);
      border: 1px dashed rgba(55,65,81,0.8);
      color: var(--muted);
      font-size: 12px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
      margin-top: 8px;
    }
    .table th, .table td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(31,41,55,0.9);
      text-align: left;
      white-space: nowrap;
    }
    .table th {
      font-size: 11px;
      color: var(--muted);
      font-weight: 500;
    }
    .table tbody tr:hover {
      background: rgba(15,23,42,0.9);
    }
    .muted { color: var(--muted); }
    .tag-risk-low {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(22,163,74,0.05);
      border: 1px solid rgba(34,197,94,0.4);
      color: #bbf7d0;
      font-size: 11px;
    }
    .tag-risk-med {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(234,179,8,0.05);
      border: 1px solid rgba(234,179,8,0.45);
      color: #fef08a;
      font-size: 11px;
    }

    .footer-meta {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 11px;
      color: var(--muted);
      align-items: center;
      justify-content: space-between;
    }
    .user-id-box {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      padding: 4px 8px;
      border-radius: 6px;
      background: rgba(15,23,42,0.95);
      border: 1px dashed rgba(55,65,81,0.8);
      font-size: 11px;
      color: #e5e7eb;
    }

    @media (max-width: 960px) {
      .layout { grid-template-columns: 60px 1fr; }
      .nav-group-label, .nav-foot-note { display: none; }
      .nav-item span.label { display: none; }
    }
    @media (max-width: 720px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { display: none; }
    }
    @media (max-width: 600px) {
      .grid { grid-template-columns: 1fr; }
    }
	.page-content {
	display: block;
	}
	.page-content.hidden {
	display: none;
	}

  </style>
</head>
<body>

<!-- Auth Page -->
<div id="authPage" class="auth-wrapper">
  <div class="auth-card">
    <div class="auth-title">
      <div class="auth-logo">â‚¿</div>
      <div class="auth-title-text">é‡‘èç³»çµ±å„€è¡¨æ¿ Pro v4.0</div>
    </div>
    <div class="auth-subtitle">Supabase é›²ç«¯ç™»å…¥ Â· å¤šè¨­å‚™åŒæ­¥</div>
    <div class="auth-badge">
      <span class="auth-cloud-dot"></span>
      é›²ç«¯èªè­‰å•Ÿç”¨
    </div>

    <div id="authMessage" class="auth-msg hidden"></div>

    <form id="loginForm">
      <div class="auth-group">
        <label for="loginEmail">é›»éƒµåœ°å€</label>
        <input id="loginEmail" type="email" class="auth-input" required />
      </div>
      <div class="auth-group">
        <label for="loginPassword">å¯†ç¢¼</label>
        <input id="loginPassword" type="password" class="auth-input" required />
      </div>
      <button id="loginBtn" type="submit" class="auth-btn auth-btn-primary">ç™»å…¥</button>
    </form>

    <form id="signupForm" class="hidden">
      <div class="auth-group">
        <label for="signupEmail">é›»éƒµåœ°å€</label>
        <input id="signupEmail" type="email" class="auth-input" required />
      </div>
      <div class="auth-group">
        <label for="signupPassword">å¯†ç¢¼ï¼ˆè‡³å°‘ 6 ä½ï¼‰</label>
        <input id="signupPassword" type="password" class="auth-input" minlength="6" required />
      </div>
      <div class="auth-group">
        <label for="signupPasswordConfirm">ç¢ºèªå¯†ç¢¼</label>
        <input id="signupPasswordConfirm" type="password" class="auth-input" minlength="6" required />
      </div>
      <button id="signupBtn" type="submit" class="auth-btn auth-btn-primary">è¨»å†Š</button>
    </form>

    <div class="auth-toggle">
      <span id="toggleText">é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ</span>
      <a id="toggleLink">ç«‹å³è¨»å†Š</a>
    </div>
  </div>
</div>

<!-- Dashboard Page (v2.4 UI) -->
<div id="dashboardPage" class="app" style="display:none;">
  <header class="top-bar">
    <div class="title-block">
      <div class="logo">â‚¿</div>
      <div>
        <div class="title-main">é‡‘èç³»çµ±å„€è¡¨æ¿ Pro v2.4</div>
        <div class="title-sub">é›²ç«¯ç‰ˆ Â· 6 å¤§åŠŸèƒ½æ¨¡çµ„ Â· å…¨è¨­å‚™åŒæ­¥ Â· å¯¦æ™‚æ›´æ–°</div>
      </div>
      <div class="badge">
        <span class="cloud-dot"></span>
        é›²ç«¯åŒæ­¥å•Ÿç”¨
      </div>
    </div>

<!-- Portfolio Selector -->
<div style="display:flex; align-items:center; gap:8px;">
  <span style="font-size:12px; color:var(--muted);">æŠ•è³‡çµ„åˆï¼š</span>
  <select id="portfolio-selector" class="auth-input" style="min-width:150px; font-size:12px; padding:6px 10px;">
    <option value="">è¼‰å…¥ä¸­...</option>
  </select>
  <button id="btn-manage-portfolios" class="btn btn-outline" style="font-size:11px; padding:5px 10px;">
    âš™ï¸ ç®¡ç†
  </button>
</div>

    <div class="user-block">
      <div class="sync-status">
        <span>ç”¨æˆ¶ Emailï¼š<span id="userEmail"></span></span>
        <span class="status">
          <span class="status-dot"></span>
          å·²é€£æ¥ Â· æ‰‹å‹•åŒæ­¥
        </span>
        <button type="button" id="logoutBtn" class="btn btn-outline" style="margin-top:4px;">ç™»å‡º</button>
      </div>
      <div class="avatar"></div>
    </div>
  </header>

  <div class="layout">
    <aside class="sidebar">
      <div>
        <div class="nav-group-label">ä¸»æ§å°</div>
        <ul class="nav-list">
          <li class="nav-item active" data-page="dashboard">
		<span class="nav-item-icon">ğŸ“Š</span>
		<span class="label">å„€è¡¨æ¿</span>
		</li>

          <li class="nav-item">
            <span class="nav-item-icon">ğŸ“ˆ</span>
            <span class="label">ETF è¿½è¹¤</span>
          </li>
          <li class="nav-item" data-page="portfolio-overview">
			<span class="nav-item-icon">ğŸ’¼</span>
			<span class="label">è·¨çµ„åˆç¸½è¦½</span>
			</li>
          <li class="nav-item">
            <span class="nav-item-icon">âš ï¸</span>
            <span class="label">é¢¨éšªè©•ä¼°</span>
          </li>
          <li class="nav-item">
            <span class="nav-item-icon">ğŸ’µ</span>
            <span class="label">ç¾é‡‘æµ & è¢«å‹•æ”¶å…¥</span>
          </li>
          <li class="nav-item">
            <span class="nav-item-icon">ğŸ“‰</span>
            <span class="label">è¡ç”Ÿå“å·¥å…·</span>
          </li>
        </ul>
      </div>
      <div>
        <div class="nav-group-label">ç³»çµ±</div>
        <ul class="nav-list">
         <li class="nav-item" data-page="api-config">
		<span class="nav-item-icon">ğŸ”‘</span>
		<span class="label">API é…ç½®</span>
		</li>


          <li class="nav-item">
            <span class="nav-item-icon">âš™ï¸</span>
            <span class="label">ç³»çµ±è¨­ç½®</span>
          </li>
        </ul>
      </div>
      <div class="nav-foot-note">
        v2.4 Â· æœ€è¿‘åŒæ­¥ï¼šæ‰‹å‹• Â· é¦™æ¸¯æ™‚å€
      </div>
    </aside>

    <main class="main">
	<div id="page-dashboard" class="page-content">
      <div class="top-row">
        <div>
          <div class="connection-pill">
            <span class="connection-dot"></span>
            å¯¦æ™‚è³‡æ–™ä¸²æµ Â· é€£æ¥ä¸­...
          </div>
          <div class="module-tags">
            <span class="module-tag">å„€è¡¨æ¿</span>
            <span class="module-tag">ETF è¿½è¹¤</span>
            <span class="module-tag">æŠ•è³‡çµ„åˆ</span>
            <span class="module-tag">é¢¨éšªè©•ä¼°</span>
            <span class="module-tag">ç¾é‡‘æµ</span>
            <span class="module-tag">è¡ç”Ÿå“</span>
          </div>
        </div>

       <div class="control-row">
  <div class="select">
    <label for="refresh-interval">åˆ·æ–°é »ç‡:</label>
    <select id="refresh-interval">
      <option value="5m">5 åˆ†é˜</option>
      <option value="15m">15 åˆ†é˜</option>
      <option value="30m">30 åˆ†é˜</option>
      <option value="1h">1 å°æ™‚</option>
      <option value="manual" selected>æ‰‹å‹•</option>
    </select>
  </div>

  <div class="input">
    <label for="tax-rate">ç¨…ç‡ (%):</label>
    <input id="tax-rate" type="number" value="30" min="0" max="100" step="0.1" />
  </div>

  <div class="input">
    <label for="rf-rate">ç„¡é¢¨éšªåˆ©ç‡ (%):</label>
    <input id="rf-rate" type="number" value="2.5" min="0" max="20" step="0.1" />
  </div>

  <button id="btnSaveSettings" class="btn btn-primary">ğŸ’¾ ä¿å­˜è¨­ç½®</button>
  <button id="btnManualSync" class="btn btn-outline">ğŸ”„ æ‰‹å‹•åŒæ­¥</button>
  <button id="btnSaveSnapshot" class="btn btn-outline">ğŸ“¸ ä¿å­˜å¿«ç…§</button>
  <button id="btnUpdatePrices" class="btn btn-outline">ğŸ’¹ æ›´æ–°æ‰€æœ‰ç¾åƒ¹</button>
</div>


      </div>

      <div class="grid">
        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span>ğŸ“ˆ æŠ•è³‡çµ„åˆç¸½è¦½</span>
                <span class="pill-soft accent">å¤šè³‡ç”¢ Â· å…¨å¸‚å ´</span>
              </div>
              <div class="card-subtitle">
                ç®¡ç†ä½ çš„æŠ•è³‡æŒå€‰ï¼Œè¿½è¹¤æˆæœ¬ã€ç¾å€¼ã€æ”¶ç›Šç‡èˆ‡ ETF è¡¨ç¾ã€‚
              </div>
            </div>
           <button id="btnAddHolding" class="btn btn-outline" style="font-size: 11px; padding-inline: 8px;">
			â• æ–°å¢æŒå€‰
			</button>
          </div>

			<div class="card-body" style="margin-top:10px;">
			<div class="placeholder" id="holdingsEmpty">
				ğŸ“Œ é‚„æ²’æœ‰ä»»ä½•æŒå€‰ã€‚æŒ‰å³ä¸Šè§’ã€Œâ• æ–°å¢æŒå€‰ã€é–‹å§‹å»ºç«‹ä½ çš„æŠ•è³‡çµ„åˆã€‚
			</div>
			
			<div id="holdingsWrap" style="display:none; overflow-x:auto;">
				<table class="table">
				<thead>
					<tr>
					<th>ä»£ç¢¼</th>
					<th>è‚¡æ•¸</th>
					<th>è²·å…¥åƒ¹</th>
					<th>ç¾åƒ¹</th>
					<th>ç¾å€¼</th>
					<th>æ”¶ç›Š</th>
					<th>æ”¶ç›Šç‡</th>
					<th>æ“ä½œ</th>
					</tr>
				</thead>
				<tbody id="holdingsTbody"></tbody>
				</table>
			</div>
			</div>


          <div class="metric-row">
            <div class="metric">
              <div class="metric-label">
                ç¸½è³‡ç”¢
                <span class="metric-pill">å«ç¾é‡‘ & è¡ç”Ÿå“</span>
              </div>
              <div class="metric-value" id="totalAssets">HK$ 0</div>
              <div class="metric-change up">
                â–³ 0.00%ï¼ˆä»Šæ—¥ï¼‰
              </div>
            </div>
            <div class="metric">
              <div class="metric-label">
                å·²å¯¦ç¾ / æœªå¯¦ç¾æ”¶ç›Š
              </div>
              <div class="metric-value" id="totalGain">HK$ 0</div>
              <div class="metric-change muted">
                å·²å¯¦ç¾ï¼š0 Â· æœªå¯¦ç¾ï¼š0
              </div>
            </div>
            <div class="metric">
              <div class="metric-label">
                å¹´åŒ–é æœŸå ±é…¬
              </div>
              <div class="metric-value" id="expectedReturn">0.0%</div>
              <div class="metric-change muted">
                é¢¨éšªèª¿æ•´å¾Œï¼š0.0%ï¼ˆSharpe 0.00ï¼‰
              </div>
            </div>
          </div>

          <div class="card-body">
            <p>ğŸ“Œ é‚„æ²’æœ‰ç›£æ§ä»»ä½• <span class="muted">ETF</span>ã€‚ä½ å¯ä»¥åœ¨ã€ŒETF è¿½è¹¤ã€æ¨¡çµ„ä¸­æ–°å¢ä»£ç¢¼ä»¥é–‹å§‹è¿½è¹¤ 5 å¹´ / 10 å¹´ CAGR èˆ‡åˆ†æ´¾ç´€éŒ„ã€‚</p>
            <div class="placeholder">
              ETF è¿½è¹¤è¡¨ï¼ˆä»£ç¢¼ Â· åç¨± Â· é¡å‹ Â· 5 å¹´ CAGR Â· 10 å¹´ CAGR Â· æè¿° Â· æ“ä½œï¼‰å¯æ”¾åœ¨æ­¤å€å¡Šã€‚  
              ç›®å‰è³‡æ–™ç‚ºç©ºï¼Œå¾…ä½ å¡«å…¥å¯¦éš›æ¸…å–®ã€‚
            </div>
          </div>
        </section>

        <section class="card">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span>âš ï¸ é¢¨éšªèˆ‡ç¾é‡‘æµ</span>
                <span class="pill-soft">é¢¨éšªè©•ä¼° Â· è¢«å‹•æ”¶å…¥ Â· è¡ç”Ÿå“</span>
              </div>
              <div class="card-subtitle">
                è©•ä¼°æŠ•è³‡çµ„åˆé¢¨éšªç­‰ç´šã€æ³¢å‹•ç‡ã€å›æ’¤èˆ‡è¢«å‹•æ”¶å…¥è¦†è“‹ç‡ã€‚
              </div>
            </div>
          </div>

          <div class="metric-row">
            <div class="metric">
              <div class="metric-label">
                çµ„åˆé¢¨éšªç­‰ç´š
              </div>
              <div class="metric-value">N/A</div>
              <div class="metric-change muted">
                æ³¢å‹•ç‡ï¼š-- Â· æœ€å¤§å›æ’¤ï¼š--
              </div>
            </div>
            <div class="metric">
              <div class="metric-label">
                é æœŸæœˆåº¦è¢«å‹•æ”¶å…¥
              </div>
              <div class="metric-value" id="passiveIncome">HK$ 0</div>
              <div class="metric-change up">
                ç”Ÿæ´»æ–¹å¼ç­‰åƒ¹ï¼š0 æ¯å’–å•¡ / 0 æ¬¡å¤–å‡ºæ™šé¤
              </div>
            </div>
          </div>

          <div class="card-body">
            <p>å°‡ä½ çš„æœˆåº¦è¢«å‹•æ”¶å…¥è½‰æ›ç‚ºæ—¥å¸¸ç”Ÿæ´»ç­‰åƒ¹æ•¸é‡ï¼Œä¸¦çµåˆè¡ç”Ÿå“ç­–ç•¥ï¼ˆè³£å‡ºçœ‹è·ŒæœŸæ¬Šã€ä¿è­·æ€§è²·æ¬Šï¼‰å„ªåŒ–é¢¨éšª / å ±é…¬çµæ§‹ã€‚</p>

            <div class="placeholder" style="margin-bottom: 8px;">
              è¡ç”Ÿå“è¨ˆç®—æ¨¡çµ„å¯æ”¾ç½®åœ¨æ­¤å€ï¼š  
              - è³£å‡ºçœ‹è·ŒæœŸæ¬Šã€ä¿è­·æ€§è²·æ¬Šæˆæœ¬  
              - æœŸæ¬Šæ”¶ç›Šèˆ‡ä¿è­‰é‡‘éœ€æ±‚  
              - å°æ²–å»ºè­°èˆ‡æƒ…å¢ƒåˆ†æ
            </div>

            <table class="table">
              <thead>
                <tr>
                  <th>ä»£ç¢¼</th>
                  <th>åç¨±</th>
                  <th>å¹´æ”¶ç›Šç‡</th>
                  <th>åˆ†æ´¾é »ç‡</th>
                  <th>é¢¨éšªç­‰ç´š</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>QQQI</td>
                  <td>iShares NASDAQ 100 Covered Call ETF</td>
                  <td>12â€“14%</td>
                  <td>æœˆåº¦</td>
                  <td><span class="tag-risk-med">ä¸­ç­‰</span></td>
                </tr>
                <tr>
                  <td>SPYI</td>
                  <td>S&amp;P 500 Covered Call ETF</td>
                  <td>8â€“10%</td>
                  <td>æœˆåº¦</td>
                  <td><span class="tag-risk-low">ä½</span></td>
                </tr>
                <tr>
                  <td>JEPI</td>
                  <td>JPMorgan Equity Premium Income</td>
                  <td>8â€“10%</td>
                  <td>æœˆåº¦</td>
                  <td><span class="tag-risk-low">ä½</span></td>
                </tr>
                <tr>
                  <td>MO</td>
                  <td>Altria Group Inc</td>
                  <td>8â€“9%</td>
                  <td>å­£åº¦</td>
                  <td><span class="tag-risk-med">ä¸­ç­‰</span></td>
                </tr>
                <tr>
                  <td>O</td>
                  <td>Realty Income Corp</td>
                  <td>3.5â€“4%</td>
                  <td>æœˆåº¦</td>
                  <td><span class="tag-risk-low">ä½</span></td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>
      </div>

<!-- åœ–è¡¨å€ -->
<div class="grid" style="margin-top:16px;">
  <!-- æŒå€‰é¤…åœ– -->
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">
          <span>ğŸ¥§ æŒå€‰åˆ†ä½ˆ</span>
          <span class="pill-soft">æŒ‰å¸‚å€¼</span>
        </div>
        <div class="card-subtitle">å„ä»£ç¢¼ä½”ç¸½å¸‚å€¼ç™¾åˆ†æ¯”</div>
      </div>
    </div>
    <div class="card-body" style="position:relative; height:280px;">
      <canvas id="chartPie"></canvas>
    </div>
  </section>

  <!-- ç¸½è³‡ç”¢è¶¨å‹¢ -->
  <section class="card">
    <div class="card-header">
      <div>
        <div class="card-title">
          <span>ğŸ“ˆ ç¸½è³‡ç”¢è¶¨å‹¢</span>
          <span class="pill-soft">è¿‘ 30 æ—¥</span>
        </div>
        <div class="card-subtitle">æ¨¡æ“¬æ•¸æ“šï¼ˆå¾…æ¥å…¥çœŸå¯¦æ­·å²å¿«ç…§ï¼‰</div>
      </div>
    </div>
    <div class="card-body" style="position:relative; height:280px;">
      <canvas id="chartLine"></canvas>
    </div>
  </section>
</div>



      <div class="footer-meta">
        <div>
          <span class="muted">ç³»çµ±ç‹€æ…‹ï¼š</span>
          <span>é›²ç«¯åŒæ­¥å·²å•Ÿç”¨ Â· API æœªé…ç½® Â· é¢¨éšªå¼•æ“å¾…åˆå§‹åŒ–</span>
        </div>
        <div class="user-id-box" id="userIdBox">
          user_id: -
        </div>
      </div>
	  </div>
	  
	  
  <!-- å„€è¡¨æ¿é é¢ -->
	

  <!-- API é…ç½®é é¢ -->
<!-- API é…ç½®é é¢ -->
<div id="page-api-config" class="page-content" style="display:none;">
  <div style="max-width: 600px;">
    <h2 style="margin-bottom: 8px;">ğŸ”‘ API é…ç½®</h2>
    <p style="font-size: 13px; color: var(--muted); margin-bottom: 20px;">
      è¨­ç½®ä½ çš„è‚¡åƒ¹ API é‡‘é‘°ï¼Œç”¨æ–¼è‡ªå‹•æ›´æ–°æŒå€‰ç¾åƒ¹ã€‚æ”¯æ´ Alpha Vantageã€Polygon æˆ– FMPã€‚
    </p>

   <!-- è²¨å¹£é¸æ“‡å™¨ -->
    <div class="card" style="margin-bottom: 16px;">
      <div class="card-header">
        <div class="card-title">ğŸ’± é¡¯ç¤ºè²¨å¹£</div>
      </div>
      <div class="card-body">
        <p style="margin-bottom: 10px; font-size: 12px;">
          é¸æ“‡ä½ çš„ä¸»è¦é¡¯ç¤ºè²¨å¹£ï¼Œæ‰€æœ‰é‡‘é¡æœƒè‡ªå‹•è½‰æ›ï¼ˆä½¿ç”¨å¯¦æ™‚åŒ¯ç‡ï¼‰ã€‚
        </p>
        <select id="select-currency" class="auth-input" style="width: 100%;">
		  <option value="USD" selected>ç¾å…ƒ (USD) - $</option>  
		  <option value="HKD">æ¸¯å¹£ (HKD) - HK$</option>  
          <option value="CNY">äººæ°‘å¹£ (CNY) - Â¥</option>
          <option value="JPY">æ—¥å…ƒ (JPY) - Â¥</option>
          <option value="TWD">å°å¹£ (TWD) - NT$</option>
          <option value="EUR">æ­å…ƒ (EUR) - â‚¬</option>
          <option value="GBP">è‹±éŠ (GBP) - Â£</option>
        </select>
      </div>
    </div>

<!-- è·¨çµ„åˆç¸½è¦½é é¢ -->
<div id="page-portfolio-overview" class="page-content" style="display:none;">
  <h2 style="margin-bottom: 16px;">ğŸ’¼ è·¨çµ„åˆç¸½è¦½</h2>

  <!-- å…¨éƒ¨çµ„åˆç¸½è³‡ç”¢ -->
  <div class="card" style="margin-bottom: 16px;">
    <div class="card-header">
      <div class="card-title">ğŸ“Š å…¨éƒ¨æŠ•è³‡çµ„åˆç¸½è³‡ç”¢</div>
    </div>
    <div class="card-body">
      <div class="metric-row">
        <div class="metric">
          <div class="metric-label">ç¸½è³‡ç”¢</div>
          <div class="metric-value" id="overview-total-assets">$ 0</div>
          <div class="metric-change muted" id="overview-portfolios-count">åŒ…å« 0 å€‹çµ„åˆ</div>
        </div>
        <div class="metric">
          <div class="metric-label">ç¸½æ”¶ç›Š</div>
          <div class="metric-value" id="overview-total-gain">$ 0</div>
          <div class="metric-change" id="overview-total-gain-pct">0.00%</div>
        </div>
        <div class="metric">
          <div class="metric-label">ç¸½æŒå€‰æ•¸</div>
          <div class="metric-value" id="overview-holdings-count">0</div>
          <div class="metric-change muted">è·¨æ‰€æœ‰çµ„åˆ</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Portfolio å°æ¯”è¡¨ -->
  <div class="card" style="margin-bottom: 16px;">
    <div class="card-header">
      <div class="card-title">ğŸ“‹ çµ„åˆå°æ¯”</div>
    </div>
    <div class="card-body">
      <div style="overflow-x:auto;">
        <table class="table">
          <thead>
            <tr>
              <th>çµ„åˆåç¨±</th>
              <th>ç¸½è³‡ç”¢</th>
              <th>æ”¶ç›Š</th>
              <th>æ”¶ç›Šç‡</th>
              <th>æŒå€‰æ•¸</th>
              <th>ä½”æ¯”</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="portfolio-comparison-tbody">
            <tr>
              <td colspan="7" style="text-align:center; color:var(--muted); padding:20px;">
                è¼‰å…¥ä¸­...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- è³‡ç”¢åˆ†ä½ˆé¤…åœ–ï¼ˆæŒ‰çµ„åˆï¼‰ -->
  <div class="grid">
    <section class="card">
      <div class="card-header">
        <div class="card-title">
          <span>ğŸ¥§ è³‡ç”¢åˆ†ä½ˆ</span>
          <span class="pill-soft">æŒ‰çµ„åˆ</span>
        </div>
      </div>
      <div class="card-body" style="position:relative; height:280px;">
        <canvas id="chartPortfolioPie"></canvas>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <div class="card-title">
          <span>ğŸ“ˆ çµ„åˆè¶¨å‹¢å°æ¯”</span>
          <span class="pill-soft">è¿‘ 30 æ—¥</span>
        </div>
      </div>
      <div class="card-body" style="position:relative; height:280px;">
        <canvas id="chartPortfolioLines"></canvas>
      </div>
    </section>
  </div>
</div>


<!-- åŒ¯ç‡æ›ç®—å™¨ -->
<div class="card" style="margin-bottom: 16px;">
  <div class="card-header">
    <div class="card-title">ğŸ§® åŒ¯ç‡æ›ç®—å™¨</div>
  </div>
  <div class="card-body">
    <div style="display:grid; grid-template-columns: 1fr auto 1fr; gap:12px; align-items:end;">
      <!-- ä¾†æº -->
      <div>
        <div style="font-size:12px; color:#9ca3af; margin-bottom:6px;">é‡‘é¡</div>
        <input 
          id="calc-amount" 
          type="number" 
          class="auth-input" 
          placeholder="100" 
          value="100"
          min="0"
          step="0.01"
        />
        <select id="calc-from" class="auth-input" style="margin-top:8px; width:100%;">
          <option value="USD" selected>ç¾å…ƒ (USD)</option>
          <option value="HKD">æ¸¯å¹£ (HKD)</option>
          <option value="CNY">äººæ°‘å¹£ (CNY)</option>
          <option value="JPY">æ—¥å…ƒ (JPY)</option>
          <option value="TWD">å°å¹£ (TWD)</option>
          <option value="EUR">æ­å…ƒ (EUR)</option>
          <option value="GBP">è‹±éŠ (GBP)</option>
        </select>
      </div>

      <!-- ç®­é ­ -->
      <div style="padding-bottom:8px; font-size:20px; color:var(--muted);">
        â†’
      </div>

      <!-- ç›®æ¨™ -->
      <div>
        <div style="font-size:12px; color:#9ca3af; margin-bottom:6px;">çµæœ</div>
        <div 
          id="calc-result" 
          style="
            padding:10px 12px; 
            border-radius:8px; 
            border:1px solid var(--border); 
            background:#020617; 
            color:#22c55e; 
            font-size:16px; 
            font-weight:600;
            text-align:right;
          "
        >
          -
        </div>
        <select id="calc-to" class="auth-input" style="margin-top:8px; width:100%;">
          <option value="USD">ç¾å…ƒ (USD)</option>
          <option value="HKD" selected>æ¸¯å¹£ (HKD)</option>
          <option value="CNY">äººæ°‘å¹£ (CNY)</option>
          <option value="JPY">æ—¥å…ƒ (JPY)</option>
          <option value="TWD">å°å¹£ (TWD)</option>
          <option value="EUR">æ­å…ƒ (EUR)</option>
          <option value="GBP">è‹±éŠ (GBP)</option>
        </select>
      </div>
    </div>
  </div>
</div>


<!-- åŒ¯ç‡åˆ—è¡¨ -->
<div class="card" style="margin-bottom: 16px;">
  <div class="card-header">
    <div style="display:flex; align-items:center; justify-content:space-between; width:100%;">
      <div class="card-title">ğŸ“Š ç•¶å‰åŒ¯ç‡</div>
      <button id="btn-refresh-rates" class="btn btn-outline" style="font-size:11px; padding:4px 10px;">
        ğŸ”„ åˆ·æ–°åŒ¯ç‡
      </button>
    </div>
  </div>
  <div class="card-body">
    <p style="margin-bottom: 10px; font-size: 12px; color: var(--muted);">
      åŸºç¤è²¨å¹£ï¼š<strong>USD</strong> Â·
      é¡¯ç¤ºè²¨å¹£ï¼š<strong id="display-currency-name">HKD</strong> Â·
      æœ€å¾Œæ›´æ–°ï¼š<span id="rates-updated-time">æœªæ›´æ–°</span>
    </p>
    <table class="table" style="margin-top:8px;">
      <thead>
        <tr>
          <th>è²¨å¹£å°</th>
          <th>åŒ¯ç‡</th>
          <th>ä¾†æº</th>
        </tr>
      </thead>
      <tbody id="rates-table-body">
        <tr>
          <td colspan="3" style="text-align:center; color:var(--muted);">
            å°šæœªè¼‰å…¥åŒ¯ç‡
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>


    <!-- Alpha Vantage -->
    <div class="card" style="margin-bottom: 16px;">
      <div class="card-header">
        <div class="card-title">Alpha Vantageï¼ˆå…è²»æ–¹æ¡ˆï¼‰</div>
      </div>
      <div class="card-body">
        <p style="margin-bottom: 10px; font-size: 12px;">
          å…è²»é¡åº¦ï¼šæ¯åˆ†é˜ 5 æ¬¡è«‹æ±‚ã€æ¯æ—¥ 500 æ¬¡ã€‚
          <a href="https://www.alphavantage.co/support/#api-key" target="_blank">ç”³è«‹å…è²» key</a>
        </p>
        <input 
          id="input-alpha-key" 
          type="text" 
          class="auth-input" 
          placeholder="è²¼ä¸Šä½ çš„ Alpha Vantage API key"
          style="margin-bottom: 8px;"
        />
      </div>
    </div>

    <!-- Polygon -->
    <div class="card" style="margin-bottom: 16px;">
      <div class="card-header">
        <div class="card-title">Polygon.ioï¼ˆä»˜è²»æ–¹æ¡ˆï¼‰</div>
      </div>
      <div class="card-body">
        <p style="margin-bottom: 10px; font-size: 12px;">
          é©åˆéœ€è¦å¯¦æ™‚æ•¸æ“šçš„ç”¨æˆ¶ã€‚
          <a href="https://polygon.io/pricing" target="_blank">æŸ¥çœ‹æ–¹æ¡ˆ</a>
        </p>
        <input 
          id="input-polygon-key" 
          type="text" 
          class="auth-input" 
          placeholder="è²¼ä¸Šä½ çš„ Polygon API keyï¼ˆå¯é¸ï¼‰"
          style="margin-bottom: 8px;"
        />
      </div>
    </div>

    <!-- FMP -->
    <div class="card" style="margin-bottom: 16px;">
      <div class="card-header">
        <div class="card-title">Financial Modeling Prepï¼ˆæ¨è–¦ï¼‰</div>
      </div>
      <div class="card-body">
        <p style="margin-bottom: 10px; font-size: 12px;">
          å…è²»é¡åº¦ï¼šæ¯æ—¥ 250 æ¬¡è«‹æ±‚ã€‚æ”¯æ´ç¾è‚¡ã€æ¸¯è‚¡ã€åŠ å¯†è²¨å¹£ã€‚
          <a href="https://site.financialmodelingprep.com/developer/docs" target="_blank">æŸ¥çœ‹æ–‡æª”</a>
        </p>
        <input 
          id="input-fmp-key" 
          type="text" 
          class="auth-input" 
          placeholder="è²¼ä¸Šä½ çš„ FMP API key"
          style="margin-bottom: 8px;"
        />
      </div>
    </div>

    <button id="btn-save-api-keys" class="btn btn-primary">ğŸ’¾ ä¿å­˜ API é‡‘é‘°</button>
    <button id="btn-test-api" class="btn btn-outline" style="margin-left: 8px;">ğŸ§ª æ¸¬è©¦é€£æ¥ï¼ˆFMPï¼‰</button>

<!-- é‡ç½®æŒ‰éˆ• -->
<div style="margin-top: 24px; padding-top: 16px; border-top: 1px dashed var(--border);">
  <button id="btn-reset-settings" class="btn btn-outline" style="color: var(--danger); border-color: var(--danger);">
    ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è¨­å®šä¸¦é‡ç½®
  </button>
  <p style="font-size: 11px; color: var(--muted); margin-top: 8px;">
    âš ï¸ æ­¤æ“ä½œæœƒæ¸…é™¤æ‰€æœ‰ API é‡‘é‘°ã€ç¨…ç‡ã€åˆ·æ–°é »ç‡ã€è²¨å¹£è¨­å®šï¼Œä¸¦è¿”å›é»˜èªå€¼ã€‚æŒå€‰æ•¸æ“šä¸å—å½±éŸ¿ã€‚
  </p>
</div>

  </div>
</div>

  
</main>

    </main>
  </div>
</div>
		<div id="holdingModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.55); z-index:99999; align-items:center; justify-content:center;">
		<div style="width:92%; max-width:520px; background:#020617; border:1px solid #1f2937; border-radius:14px; padding:16px;">
			<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
			<div id="holdingModalTitle" style="font-weight:600;">æ–°å¢æŒå€‰</div>
			<button id="btnCloseModal" class="btn btn-outline" type="button">âœ•</button>
			</div>

			<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
			<div>
				<div style="font-size:12px; color:#9ca3af; margin-bottom:6px;">ä»£ç¢¼ï¼ˆTickerï¼‰</div>
				<input id="mSymbol" class="auth-input" placeholder="AAPL" />
			</div>
			<div>
				<div style="font-size:12px; color:#9ca3af; margin-bottom:6px;">è‚¡æ•¸</div>
				<input id="mQty" class="auth-input" type="number" step="0.01" placeholder="10" />
			</div>
			<div>
				<div style="font-size:12px; color:#9ca3af; margin-bottom:6px;">è²·å…¥åƒ¹</div>
				<input id="mCost" class="auth-input" type="number" step="0.01" placeholder="150" />
			</div>
			<div>
				<div style="font-size:12px; color:#9ca3af; margin-bottom:6px;">ç¾åƒ¹ï¼ˆæš«ç”¨æ‰‹å¡«ï¼‰</div>
				<input id="mPrice" class="auth-input" type="number" step="0.01" placeholder="160" />
			</div>
			</div>

    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
      <button id="btnSaveHolding" class="btn btn-primary" type="button">ä¿å­˜</button>
      <button id="btnCancelHolding" class="btn btn-outline" type="button">å–æ¶ˆ</button>
    </div>
  </div>
</div>

<!-- Portfolio ç®¡ç† Modal -->
<div id="portfolioModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:99999; align-items:center; justify-content:center;">
  <div style="width:92%; max-width:600px; background:#020617; border:1px solid #1f2937; border-radius:14px; padding:20px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <div style="font-weight:600; font-size:15px;">ğŸ“‚ æŠ•è³‡çµ„åˆç®¡ç†</div>
      <button id="btnClosePortfolioModal" class="btn btn-outline" type="button">âœ•</button>
    </div>

    <!-- æ–°å¢ Portfolio -->
    <div style="margin-bottom:20px; padding:12px; border-radius:10px; background:rgba(15,23,42,0.9); border:1px solid rgba(31,41,55,0.9);">
      <div style="font-size:13px; margin-bottom:8px; color:#e5e7eb;">æ–°å¢æŠ•è³‡çµ„åˆ</div>
      <div style="display:flex; gap:8px;">
        <input 
          id="input-new-portfolio-name" 
          type="text" 
          class="auth-input" 
          placeholder="ä¾‹å¦‚ï¼šç¾è‚¡æˆé•·ã€æ¸¯è‚¡é«˜æ¯ã€åŠ å¯†è²¨å¹£"
          style="flex:1;"
        />
        <button id="btn-create-portfolio" class="btn btn-primary" type="button">
          â• æ–°å¢
        </button>
      </div>
    </div>

    <!-- Portfolio åˆ—è¡¨ -->
    <div style="font-size:13px; margin-bottom:8px; color:#9ca3af;">ç¾æœ‰çµ„åˆ</div>
    <div id="portfolio-list" style="max-height:300px; overflow-y:auto;">
      <!-- å‹•æ…‹å¡«å…… -->
    </div>
  </div>
</div>

<script>
  // ä½ çš„ JavaScript ä»£ç¢¼
  ...
</script>
</body>
</html>


<script>
console.clear();
console.log('ğŸš€ v4 App start');

// å…¨åŸŸç‹€æ…‹
var app = {
  supabase: null,
  user: null,
  editingHoldingId: null,
  holdingsUIBound: false,
  chartPie: null,
  chartLine: null,
  refreshTimer: null,
   chartPortfolioPie: null,
  chartPortfolioLines: null,
  // åŒ¯ç‡ cache
  baseCurrency: 'USD',
  displayCurrency: 'USD',
  exchangeRates: {},
  exchangeRatesUpdated: null,  // âœ… åŠ é€—è™Ÿ
  
  // Portfolio
  currentPortfolioId: null,    // âœ… åŠ é€—è™Ÿ
  portfolios: []
  

};



window.onload = async function () {
  const SUPABASE_URL = 'https://umssuhublguujswugbps.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVtc3N1aHVibGd1dWpzd3VnYnBzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc4ODQ0MzIsImV4cCI6MjA4MzQ2MDQzMn0.VtRv66cXdbZf0n1qAwFFuSFH4kvuqB0hTgrogNfRD3A'; // â† ä½ åŸæœ¬å—°æ¢ key æ”¾è¿”å…¥åšŸ

  app.supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  console.log('âœ… Supabase init');

  bindAuthEvents();

  const { data: { session } } = await app.supabase.auth.getSession();
  if (session) {
    showDashboard(session.user);
  } else {
    showAuth();
  }

  app.supabase.auth.onAuthStateChange(function (event, session) {
    console.log('ğŸ” Auth event:', event);
    if (event === 'SIGNED_IN' && session) {
      showDashboard(session.user);
    } else if (event === 'SIGNED_OUT') {
  // âœ… ä¿éšªï¼šä»»ä½•åŸå› ç™»å‡ºéƒ½åœ timer
  if (app.refreshTimer) {
    clearInterval(app.refreshTimer); // [web:50]
    app.refreshTimer = null;
  }
  showAuth();
}

  });
};

function bindAuthEvents() {
  var loginForm = document.getElementById('loginForm');
  var signupForm = document.getElementById('signupForm');
  var toggleLink = document.getElementById('toggleLink');
  var toggleText = document.getElementById('toggleText');
  var authMessage = document.getElementById('authMessage');
  var loginBtn = document.getElementById('loginBtn');
  var signupBtn = document.getElementById('signupBtn');

  function showMsg(text, type) {
    authMessage.textContent = text;
    authMessage.className = 'auth-msg ' + type;
    authMessage.classList.remove('hidden');
  }
  function hideMsg() {
    authMessage.classList.add('hidden');
  }

  toggleLink.onclick = function () {
    hideMsg();
    if (loginForm.classList.contains('hidden')) {
      loginForm.classList.remove('hidden');
      signupForm.classList.add('hidden');
      toggleText.textContent = 'é‚„æ²’æœ‰å¸³è™Ÿï¼Ÿ';
      toggleLink.textContent = 'ç«‹å³è¨»å†Š';
    } else {
      loginForm.classList.add('hidden');
      signupForm.classList.remove('hidden');
      toggleText.textContent = 'å·²æœ‰å¸³è™Ÿï¼Ÿ';
      toggleLink.textContent = 'è¿”å›ç™»å…¥';
    }
  };

  loginForm.onsubmit = async function (e) {
    e.preventDefault();
    hideMsg();

    var email = document.getElementById('loginEmail').value;
    var password = document.getElementById('loginPassword').value;

    loginBtn.disabled = true;
    loginBtn.textContent = 'ç™»å…¥ä¸­...';

    var { error } = await app.supabase.auth.signInWithPassword({ email, password });

    loginBtn.disabled = false;
    loginBtn.textContent = 'ç™»å…¥';

    if (error) showMsg('ç™»å…¥å¤±æ•—ï¼š' + error.message, 'error');
    else showMsg('ç™»å…¥æˆåŠŸï¼', 'success');
  };

  signupForm.onsubmit = async function (e) {
    e.preventDefault();
    hideMsg();

    var email = document.getElementById('signupEmail').value;
    var password = document.getElementById('signupPassword').value;
    var confirm = document.getElementById('signupPasswordConfirm').value;

    if (password !== confirm) {
      showMsg('å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´', 'error');
      return;
    }

    signupBtn.disabled = true;
    signupBtn.textContent = 'è¨»å†Šä¸­...';

    var { error } = await app.supabase.auth.signUp({ email, password });

    signupBtn.disabled = false;
    signupBtn.textContent = 'è¨»å†Š';

    if (error) showMsg('è¨»å†Šå¤±æ•—ï¼š' + error.message, 'error');
    else {
      showMsg('è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥é›»éƒµé©—è­‰ã€‚', 'success');
      signupForm.reset();
    }
  };

document.getElementById('logoutBtn').onclick = async function() {
  if (!confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) return;

  // âœ… åœæ­¢è‡ªå‹•åˆ·æ–°
  if (app.refreshTimer) {
    clearInterval(app.refreshTimer); // [web:50]
    app.refreshTimer = null;
  }

  localStorage.clear();
  sessionStorage.clear();
  await app.supabase.auth.signOut();
};

}

function showAuth() {
  document.getElementById('authPage').style.display = 'flex';
  document.getElementById('dashboardPage').style.display = 'none';
  
   destroyChart('chartPie');
   destroyChart('chartLine');
     if (app.chartPortfolioPie) { app.chartPortfolioPie.destroy(); app.chartPortfolioPie = null; }
  if (app.chartPortfolioLines) { app.chartPortfolioLines.destroy(); app.chartPortfolioLines = null; }
	function showAuth() {
  document.getElementById('authPage').style.display = 'flex';
  document.getElementById('dashboardPage').style.display = 'none';
  
  destroyChart('chartPie');
  destroyChart('chartLine');
  
  // âœ… æ¸…ç†è·¨çµ„åˆåœ–è¡¨
  if (app.chartPortfolioPie) {
    app.chartPortfolioPie.destroy();
    app.chartPortfolioPie = null;
  }
}

}

async function showDashboard(user) {
  app.user = user;
  
  document.getElementById('authPage').style.display = 'none';
  document.getElementById('dashboardPage').style.display = 'grid';
  document.getElementById('userEmail').textContent = user.email;
  document.getElementById('userIdBox').textContent = 'user_id: ' + user.id;

  // âœ… å…ˆè¼‰å…¥ portfolios
  await loadPortfolios();
  bindPortfolioSelector();
  bindPortfolioManager();

  bindPageNavigation();
  bindPortfolioOverviewPage();  // âœ… åŠ å‘¢è¡Œ
  bindAPIConfig();
  bindCurrencySelector();
  switchPage('dashboard');

  // âœ… åªæœ‰ä¸€å€‹ apiNavItem
  const apiNavItem = document.querySelector('.nav-item[data-page="api-config"]');
  if (apiNavItem) {
    apiNavItem.addEventListener('click', async () => {
      await loadAPIKeys();
      await loadCurrencySetting();
	      displayExchangeRates();  // âœ… åŠ å‘¢è¡Œ
    bindRatesDisplay();      // âœ… åŠ å‘¢è¡Œ
	bindCalculator();      // âœ… åŠ å‘¢è¡Œ
	bindResetSettings();  // âœ… åŠ å‘¢è¡Œ
    await calculateExchange(); // âœ… åˆå§‹è¨ˆç®—ä¸€æ¬¡
    });
  }

  bindSettingsUI();
  await loadSettingsAndApply();
  bindHoldingsUI();
  await loadHoldingsAndRender();
  bindSyncUI();
  applyRefreshInterval(document.getElementById('refresh-interval')?.value || 'manual');

  const btnSnapshot = document.getElementById('btnSaveSnapshot');
  if (btnSnapshot && !btnSnapshot.dataset.bound) {
    btnSnapshot.dataset.bound = '1';
    btnSnapshot.addEventListener('click', saveSnapshotManually);
  }

  await saveSnapshotIfNeeded();
  bindUpdatePrices();  // âœ… ç¶å®šæ›´æ–°åƒ¹æ ¼æŒ‰éˆ•


}


/* =========================
   Holdings (Portfolio) Logic
   ========================= */

// 1) ç¢ºä¿ default portfolio å­˜åœ¨
async function ensureDefaultPortfolio(userId) {
  const { data: existing, error: qErr } = await app.supabase
    .from('portfolios')
    .select('id, portfolio_name')
    .eq('user_id', userId)
    .order('created_at', { ascending: true })
    .limit(1);

  if (qErr) throw qErr;
  if (existing && existing.length > 0) return existing[0].id;

  const { data: created, error: iErr } = await app.supabase
    .from('portfolios')
    .insert([{ user_id: userId, portfolio_name: 'Default Portfolio' }])
    .select('id')
    .single();

  if (iErr) throw iErr;
  return created.id;
}

// 2) è®€å– holdings + æ›´æ–° UI
async function loadHoldingsAndRender() {
  if (!app.user) return;

const portfolioId = app.currentPortfolioId || await ensureDefaultPortfolio(app.user.id);

  const { data: rows, error } = await app.supabase
    .from('holdings')
    .select('id, symbol, quantity, cost_price, current_price, current_value, gain, gain_percent')
    .eq('user_id', app.user.id)
    .eq('portfolio_id', portfolioId)
    .order('created_at', { ascending: false });

  if (error) throw error;

  const empty = document.getElementById('holdingsEmpty');
  const wrap = document.getElementById('holdingsWrap');
  const tbody = document.getElementById('holdingsTbody');

  tbody.innerHTML = '';

  if (!rows || rows.length === 0) {
    empty.style.display = 'block';
    wrap.style.display = 'none';
    document.getElementById('totalAssets').textContent = 'HK$ 0';
    document.getElementById('totalGain').textContent = 'HK$ 0';
    return;
  }

  empty.style.display = 'none';
  wrap.style.display = 'block';

  let totalValue = 0;
  let totalGain = 0;

for (const r of rows) {
  const qty = Number(r.quantity || 0);
  const cost = Number(r.cost_price || 0);
  const price = Number(r.current_price ?? r.cost_price ?? 0);

  const totalCost = qty * cost;
  const currentValue = (r.current_value != null) ? Number(r.current_value) : qty * price;
  const gain = (r.gain != null) ? Number(r.gain) : (currentValue - totalCost);
  const gainPct = (r.gain_percent != null)
    ? Number(r.gain_percent)
    : (totalCost > 0 ? (gain / totalCost * 100) : 0);  // âœ…

  totalValue += currentValue;
  totalGain += gain;

  // âœ… ç”¨ formatCurrency è½‰æ›
// å–®åƒ¹ï¼šç›´æ¥é¡¯ç¤º USDï¼ˆå””è½‰æ›ï¼‰
const costStr = '$ ' + cost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
const priceStr = '$ ' + price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

// ç¸½é‡‘é¡ï¼šè½‰æ›æˆé¡¯ç¤ºè²¨å¹£
const valueStr = await formatCurrency(currentValue);
const gainStr = await formatCurrency(gain);


  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><strong>${(r.symbol || '').toUpperCase()}</strong></td>
    <td>${qty.toFixed(2)}</td>
    <td>${costStr}</td>
    <td>${priceStr}</td>
    <td>${valueStr}</td>
    <td style="color:${gain >= 0 ? '#4ade80' : '#ef4444'}"><strong>${gainStr}</strong></td>
    <td style="color:${gainPct >= 0 ? '#4ade80' : '#ef4444'}"><strong>${gainPct.toFixed(2)}%</strong></td>
    <td style="display:flex; gap:6px;">
      <button class="btn btn-outline" type="button"
        data-edit="${r.id}"
        data-symbol="${(r.symbol || '').toUpperCase()}"
        data-qty="${qty}"
        data-cost="${cost}"
        data-price="${price}"
      >ç·¨è¼¯</button>
      <button class="btn btn-outline" type="button" data-del="${r.id}">åˆªé™¤</button>
    </td>
  `;
  tbody.appendChild(tr);
}  // âœ…

// âœ… æ›´æ–°ç¸½è³‡ç”¢/ç¸½æ”¶ç›Šï¼ˆfor å¾ªç’°å¤–é¢ï¼‰
const totalAssetsStr = await formatCurrency(totalValue);
const totalGainStr = await formatCurrency(totalGain);
document.getElementById('totalAssets').textContent = totalAssetsStr;
document.getElementById('totalGain').textContent = totalGainStr;




  // äº‹ä»¶å§”æ´¾ï¼šåªç¶ä¸€æ¬¡
  if (!tbody.dataset.bound) {
    tbody.dataset.bound = '1';

    tbody.addEventListener('click', async (e) => {
      const editBtn = e.target.closest('button[data-edit]');
      const delBtn = e.target.closest('button[data-del]');

      if (editBtn) {
        openHoldingModalForEdit({
          id: editBtn.dataset.edit,
          symbol: editBtn.dataset.symbol,
          quantity: editBtn.dataset.qty,
          cost_price: editBtn.dataset.cost,
          current_price: editBtn.dataset.price
        });
        return;
      }

      if (delBtn) {
        const id = delBtn.dataset.del;
        if (!confirm('ç¢ºå®šåˆªé™¤é€™ç­†æŒå€‰ï¼Ÿ')) return;
        await deleteHolding(id);
        await loadHoldingsAndRender();
      }
    });
  }
  renderCharts(); // âœ… æ¯æ¬¡é‡æ–° render holdings éƒ½åŒæ­¥æ›´æ–°åœ–è¡¨
  // âœ… æ¯æ¬¡æ›´æ–° holdings å¾Œï¼Œæ›´æ–°ä»Šæ—¥å¿«ç…§ï¼ˆå¦‚æœå·²å­˜åœ¨å°±è¦†è“‹ï¼‰

// æ›´æ–°è¢«å‹•æ”¶å…¥ï¼ˆæš«æ™‚é¡¯ç¤º 0ï¼Œä¹‹å¾Œæ¥çœŸå¯¦åˆ†ç´…æ•¸æ“šï¼‰
const passiveIncomeStr = await formatCurrency(0);
const passiveIncomeEl = document.getElementById('passiveIncome');
if (passiveIncomeEl) passiveIncomeEl.textContent = passiveIncomeStr;


}

// 3) æ–°å¢æŒå€‰
async function createHoldingFromModal() {
  try {
    const symbol = document.getElementById('mSymbol').value.trim().toUpperCase();
    const addQty = Number(document.getElementById('mQty').value);
    const addCost = Number(document.getElementById('mCost').value);
    const currentPrice = Number(document.getElementById('mPrice').value);

    if (!app.user || !app.user.id) {
      alert('âŒ ç”¨æˆ¶æœªç™»å…¥');
      return;
    }
    if (!symbol || !Number.isFinite(addQty) || addQty <= 0 || !Number.isFinite(addCost) || addCost <= 0 || !Number.isFinite(currentPrice) || currentPrice <= 0) {
      alert('âŒ è«‹è¼¸å…¥æœ‰æ•ˆçš„ä»£ç¢¼/è‚¡æ•¸/è²·å…¥åƒ¹/ç¾åƒ¹ï¼ˆéƒ½è¦ > 0ï¼‰');
      return;
    }

const portfolioId = app.currentPortfolioId || await ensureDefaultPortfolio(app.user.id);

    // 1) å…ˆæŸ¥æœ‰å†‡åŒ tickerï¼ˆåŒä¸€ portfolioï¼‰
    const { data: existingRows, error: qErr } = await app.supabase
      .from('holdings')
      .select('id, quantity, cost_price')
      .eq('user_id', app.user.id)
      .eq('portfolio_id', portfolioId)
      .eq('symbol', symbol)
      .limit(1);

    if (qErr) throw qErr;

    const purchaseDate = new Date().toISOString().slice(0, 10);

    // 2) å¦‚æœå­˜åœ¨ â†’ åŠ å€‰ï¼ˆupdateï¼‰
    if (existingRows && existingRows.length > 0) {
      const row = existingRows[0];

      const oldQty = Number(row.quantity || 0);
      const oldCost = Number(row.cost_price || 0);

      const newQty = oldQty + addQty;

      // åŠ æ¬Šå¹³å‡æˆæœ¬
      const newCost =
        newQty > 0 ? ((oldQty * oldCost) + (addQty * addCost)) / newQty : addCost;

      const totalCost = newQty * newCost;
      const currentValue = newQty * currentPrice;
      const gain = currentValue - totalCost;
      const gainPercent = totalCost > 0 ? (gain / totalCost * 100) : 0;

      const { error: uErr } = await app.supabase
        .from('holdings')
        .update({
          quantity: newQty,
          cost_price: newCost,
          current_price: currentPrice,
          current_value: currentValue,
          gain: gain,
          gain_percent: gainPercent,
          purchase_date: purchaseDate
        })
        .eq('id', row.id)
        .eq('user_id', app.user.id);

      if (uErr) throw uErr;

      return; // âœ… çµæŸ
    }

    // 3) å¦‚æœä¸å­˜åœ¨ â†’ æ–°å¢ï¼ˆinsertï¼‰
    const totalCost = addQty * addCost;
    const currentValue = addQty * currentPrice;
    const gain = currentValue - totalCost;
    const gainPercent = totalCost > 0 ? (gain / totalCost * 100) : 0;

    const { error: iErr } = await app.supabase
      .from('holdings')
      .insert([{
        user_id: app.user.id,
        portfolio_id: portfolioId,
        symbol: symbol,
        quantity: addQty,
        cost_price: addCost,
        purchase_date: purchaseDate,
        current_price: currentPrice,
        current_value: currentValue,
        gain: gain,
        gain_percent: gainPercent
      }]);

    if (iErr) throw iErr;

  } catch (e) {
    console.error('createHoldingFromModal error:', e);
    alert('æ–°å¢/åŠ å€‰å¤±æ•—ï¼š' + (e.message || e));
  }
}


// 4) ç·¨è¼¯ï¼šé–‹çª— + å¡«å€¼
function openHoldingModalForEdit(row) {
  app.editingHoldingId = row.id;

  const titleEl = document.getElementById('holdingModalTitle');
  const saveBtn = document.getElementById('btnSaveHolding');
  if (titleEl) titleEl.textContent = 'ç·¨è¼¯æŒå€‰';
  if (saveBtn) saveBtn.textContent = 'æ›´æ–°';

  document.getElementById('mSymbol').value = (row.symbol || '').toUpperCase();
  document.getElementById('mQty').value = Number(row.quantity) || 0;
  document.getElementById('mCost').value = Number(row.cost_price) || 0;
  document.getElementById('mPrice').value = Number(row.current_price ?? row.cost_price ?? 0);

  openHoldingModal();
}

// 5) æ›´æ–°æŒå€‰
async function updateHoldingFromModal() {
  if (!app.editingHoldingId) throw new Error('editingHoldingId missing');

  const symbol = document.getElementById('mSymbol').value.trim().toUpperCase();
  const quantity = Number(document.getElementById('mQty').value);
  const cost_price = Number(document.getElementById('mCost').value);
  const current_price = Number(document.getElementById('mPrice').value);

  if (!symbol || !Number.isFinite(quantity) || !Number.isFinite(cost_price) || !Number.isFinite(current_price)) {
    alert('âŒ è«‹è¼¸å…¥å®Œæ•´ä¸”æœ‰æ•ˆçš„æ•¸å€¼');
    return;
  }

  const total_cost = quantity * cost_price;
  const current_value = quantity * current_price;
  const gain = current_value - total_cost;
  const gain_percent = total_cost > 0 ? (gain / total_cost * 100) : 0;

  const { error } = await app.supabase
    .from('holdings')
    .update({
      symbol,
      quantity,
      cost_price,
      current_price,
      current_value,
      gain,
      gain_percent
    })
    .eq('id', app.editingHoldingId)
    .eq('user_id', app.user.id);

  if (error) throw error;

  app.editingHoldingId = null;
}

// 6) åˆªé™¤æŒå€‰
async function deleteHolding(id) {
  const { error } = await app.supabase
    .from('holdings')
    .delete()
    .eq('id', id)
    .eq('user_id', app.user.id);

  if (error) throw error;
}

/* =========================
   Modal + UI Binding
   ========================= */

function openHoldingModal() {
  document.getElementById('holdingModal').style.display = 'flex';
}

function openHoldingModalForAdd() {
  app.editingHoldingId = null;

  const titleEl = document.getElementById('holdingModalTitle');
  const saveBtn = document.getElementById('btnSaveHolding');
  if (titleEl) titleEl.textContent = 'æ–°å¢æŒå€‰';
  if (saveBtn) saveBtn.textContent = 'ä¿å­˜';

  document.getElementById('mSymbol').value = '';
  document.getElementById('mQty').value = '';
  document.getElementById('mCost').value = '';
  document.getElementById('mPrice').value = '';

  openHoldingModal();
}



function closeHoldingModal() {
  document.getElementById('holdingModal').style.display = 'none';
  document.getElementById('mSymbol').value = '';
  document.getElementById('mQty').value = '';
  document.getElementById('mCost').value = '';
  document.getElementById('mPrice').value = '';
  app.editingHoldingId = null;
}

function bindHoldingsUI() {
  if (app.holdingsUIBound) return; // âœ… é˜²æ­¢é‡è¤‡ç¶å®š
  app.holdingsUIBound = true;

  const btnAdd = document.getElementById('btnAddHolding');
  const btnClose = document.getElementById('btnCloseModal');
  const btnCancel = document.getElementById('btnCancelHolding');
  const btnSave = document.getElementById('btnSaveHolding');

  if (btnAdd) btnAdd.addEventListener('click', openHoldingModalForAdd);
  if (btnClose) btnClose.addEventListener('click', closeHoldingModal);
  if (btnCancel) btnCancel.addEventListener('click', closeHoldingModal);

  if (btnSave) {
    btnSave.addEventListener('click', async () => {
      try {
        btnSave.disabled = true;

        if (app.editingHoldingId) {
          await updateHoldingFromModal();
        } else {
          await createHoldingFromModal();
        }

        closeHoldingModal();
        await loadHoldingsAndRender();
      } catch (e) {
        console.error('Save error:', e);
        alert('ä¿å­˜å¤±æ•—ï¼š' + (e.message || e));
      } finally {
        btnSave.disabled = false;
      }
    });
  }
  
}
function bindSettingsUI() {
  const btn = document.getElementById('btnSaveSettings');
  if (!btn || btn.dataset.bound) return;
  btn.dataset.bound = '1';

  btn.addEventListener('click', async () => {
    try {
      if (!app.user) return alert('âŒ æœªç™»å…¥');

      btn.disabled = true;
      btn.textContent = 'ä¿å­˜ä¸­...';

      const taxRate = Number(document.getElementById('tax-rate').value);
      const rfRate = Number(document.getElementById('rf-rate').value);
      const refreshInterval = document.getElementById('refresh-interval')?.value || 'manual';

      if (!Number.isFinite(taxRate) || taxRate < 0 || taxRate > 100) {
        alert('âŒ ç¨…ç‡è¦ 0-100');
        return;
      }
      if (!Number.isFinite(rfRate) || rfRate < 0 || rfRate > 100) {
        alert('âŒ ç„¡é¢¨éšªåˆ©ç‡è¦åˆç†æ•¸å€¼');
        return;
      }

      const payload = {
        user_id: app.user.id,
        tax_rate: taxRate,
        rf_rate: rfRate,
        refresh_interval: refreshInterval,
        currency: 'HKD',
        updated_at: new Date().toISOString()
      };

      const { error } = await app.supabase
        .from('settings')
        .upsert(payload, { onConflict: 'user_id' }); // ä¾ user_id å­˜/æ›´æ–° [web:35]

      if (error) throw error;

      alert('âœ… è¨­ç½®å·²ä¿å­˜');
    } catch (e) {
      console.error('save settings error:', e);
      alert('ä¿å­˜å¤±æ•—ï¼š' + (e.message || e));
    } finally {
      btn.disabled = false;
      btn.textContent = 'ğŸ’¾ ä¿å­˜è¨­ç½®';
    }
  });
}

async function loadSettingsAndApply() {
  if (!app.user) return;

  const { data, error } = await app.supabase
    .from('settings')
    .select('tax_rate, rf_rate, refresh_interval, currency')
    .eq('user_id', app.user.id)
    .maybeSingle();

  if (error) {
    console.error('load settings error:', error);
    return;
  }

  // ç„¡è³‡æ–™å°±ç”¨é è¨­
  document.getElementById('tax-rate').value = (data?.tax_rate ?? 30);
  document.getElementById('rf-rate').value = (data?.rf_rate ?? 2.5);

  const sel = document.getElementById('refresh-interval');
  if (sel) sel.value = (data?.refresh_interval ?? 'manual');
}
// ===== Refresh + Manual Sync =====
app.refreshTimer = null;

function parseRefreshIntervalToMs(v) {
  if (!v || v === 'manual') return null;
  if (v === '5m') return 5 * 60 * 1000;
  if (v === '15m') return 15 * 60 * 1000;
  if (v === '30m') return 30 * 60 * 1000;
  if (v === '1h') return 60 * 60 * 1000;
  return null;
}

function applyRefreshInterval(v) {
  // æ¸…æ‰èˆŠ timer
  if (app.refreshTimer) {
    clearInterval(app.refreshTimer);
    app.refreshTimer = null;
  }

  const ms = parseRefreshIntervalToMs(v);
  if (!ms) return;

  // åˆ¤æ–·æ˜¯å¦è‡ªå‹•æ›´æ–°åƒ¹æ ¼ï¼ˆ15 åˆ†é˜æˆ–ä»¥ä¸Šæ‰æ›´æ–°ï¼‰
  const shouldUpdatePrices = (v === '15m' || v === '30m' || v === '1h');

  // ç«‹å³è·‘ä¸€æ¬¡
  safeSyncOnce('auto', shouldUpdatePrices);

  app.refreshTimer = setInterval(() => {
    safeSyncOnce('auto', shouldUpdatePrices);
  }, ms);

  console.log(`â° è‡ªå‹•åˆ·æ–°å·²å•Ÿç”¨ï¼š${v}${shouldUpdatePrices ? 'ï¼ˆå«åƒ¹æ ¼æ›´æ–°ï¼‰' : 'ï¼ˆåƒ… UIï¼‰'}`);
}


async function safeSyncOnce(mode, updatePrices = false) {
  if (!app.user) return;

  const btn = document.getElementById('btnManualSync');
  try {
    if (btn && mode === 'manual') {
      btn.disabled = true;
      btn.textContent = 'åŒæ­¥ä¸­...';
    }

    // 1) å…ˆæ›´æ–°åƒ¹æ ¼ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if (updatePrices) {
      console.log('ğŸ”„ è‡ªå‹•æ›´æ–°åƒ¹æ ¼...');
      await updateAllPricesQuiet(); // éœé»˜æ¨¡å¼ï¼ˆä¸å½ˆ alertï¼‰
    }

    // 2) å† refresh UI
    await loadHoldingsAndRender();

    // é¡¯ç¤ºæœ€å¾ŒåŒæ­¥æ™‚é–“
    const t = new Date();
    const hh = String(t.getHours()).padStart(2, '0');
    const mm = String(t.getMinutes()).padStart(2, '0');
    const ss = String(t.getSeconds()).padStart(2, '0');
    if (btn) btn.textContent = `ğŸ”„ æ‰‹å‹•åŒæ­¥ï¼ˆ${hh}:${mm}:${ss}ï¼‰`;
  } catch (e) {
    console.error('sync error:', e);
    if (mode === 'manual') alert('åŒæ­¥å¤±æ•—ï¼š' + (e.message || e));
    if (btn) btn.textContent = 'ğŸ”„ æ‰‹å‹•åŒæ­¥';
  } finally {
    if (btn) btn.disabled = false;
  }
}


function bindSyncUI() {
  const sel = document.getElementById('refresh-interval');
  const btn = document.getElementById('btnManualSync');

  if (sel && !sel.dataset.bound) {
    sel.dataset.bound = '1';
    sel.addEventListener('change', async () => {
      const newVal = sel.value;
      
      // 1) å³åˆ»å¥—ç”¨æ–°é »ç‡
      applyRefreshInterval(newVal);

      // 2) è‡ªå‹•å¯«å› DBï¼ˆå…æŒ‰ä¿å­˜ï¼‰
      if (app.user) {
        try {
          const { error } = await app.supabase
            .from('settings')
            .upsert({
              user_id: app.user.id,
              refresh_interval: newVal,
              updated_at: new Date().toISOString()
            }, { onConflict: 'user_id' });

          if (error) throw error;

          console.log('âœ… refresh_interval å·²è‡ªå‹•ä¿å­˜:', newVal);
        } catch (e) {
          console.error('è‡ªå‹•ä¿å­˜ refresh_interval å¤±æ•—:', e);
          // å”” alert ç”¨æˆ¶ï¼Œéœéœè¨˜ log å°±å¥½ï¼ˆå› ç‚ºä½¢åªä¿‚æ”¹å€‹ dropdownï¼‰
        }
      }
    });
  }

  if (btn && !btn.dataset.bound) {
    btn.dataset.bound = '1';
    btn.addEventListener('click', () => safeSyncOnce('manual'));
  }
}

// ===== Page Navigation =====
function switchPage(pageName) {
  document.querySelectorAll(".page-content").forEach((page) => {
    page.style.display = "none";
  });

  const targetPage = document.getElementById("page-" + pageName);
  if (!targetPage) {
    console.error("[switchPage] page not found:", pageName);
    // fallbackï¼šè‡³å°‘é¡¯ç¤º dashboardï¼Œé¿å…ç©ºç™½
    const dash = document.getElementById("page-dashboard");
    if (dash) dash.style.display = "block";
    return;
  }

  targetPage.style.display = "block";

  document.querySelectorAll(".nav-item").forEach((item) => item.classList.remove("active"));
  const activeItem = document.querySelector(`.nav-item[data-page="${pageName}"]`);
  if (activeItem) activeItem.classList.add("active");
}


function bindPageNavigation() {
  document.querySelectorAll('.nav-item[data-page]').forEach(item => {
    item.addEventListener('click', () => {
      const pageName = item.getAttribute('data-page');
      switchPage(pageName);
    });
  });
}

// ç›£è½é€²å…¥è·¨çµ„åˆç¸½è¦½é é¢
function bindPortfolioOverviewPage() {
  const navItem = document.querySelector('.nav-item[data-page="portfolio-overview"]');
  if (!navItem || navItem.dataset.boundOverview) return;
  navItem.dataset.boundOverview = "1";

  navItem.addEventListener("click", async () => {
    switchPage("portfolio-overview");
    await loadPortfolioOverview();
  });
}




// ===== API Keys Management =====
// ===== API Keys Management =====
async function loadAPIKeys() {
  if (!app.user) return;

  const { data } = await app.supabase
    .from('settings')
    .select('alpha_vantage_key, polygon_key, fmp_key')
    .eq('user_id', app.user.id)
    .maybeSingle();

  if (data) {
    document.getElementById('input-alpha-key').value = data.alpha_vantage_key || '';
    document.getElementById('input-polygon-key').value = data.polygon_key || '';
    document.getElementById('input-fmp-key').value = data.fmp_key || '';
  }
}

async function saveAPIKeys() {
  if (!app.user) return alert('âŒ æœªç™»å…¥');

  const btn = document.getElementById('btn-save-api-keys');
  try {
    btn.disabled = true;
    btn.textContent = 'ä¿å­˜ä¸­...';

    const alphaKey = document.getElementById('input-alpha-key').value.trim();
    const polygonKey = document.getElementById('input-polygon-key').value.trim();
    const fmpKey = document.getElementById('input-fmp-key').value.trim();

    const { error } = await app.supabase
  .from('settings')
  .upsert({
    user_id: app.user.id,
    alpha_vantage_key: alphaKey,
    polygon_key: polygonKey,
    fmp_key: fmpKey,
    currency: document.getElementById('select-currency').value,  // âœ… åŠ å‘¢è¡Œ
    updated_at: new Date().toISOString()
  }, { onConflict: 'user_id' });


    if (error) throw error;

    alert('âœ… API é‡‘é‘°å·²ä¿å­˜');
  } catch (e) {
    console.error('ä¿å­˜ API keys å¤±æ•—:', e);
    alert('ä¿å­˜å¤±æ•—ï¼š' + (e.message || e));
  } finally {
    btn.disabled = false;
    btn.textContent = 'ğŸ’¾ ä¿å­˜ API é‡‘é‘°';
  }
}

async function testAPIConnection() {
  if (!app.user) return alert('âŒ æœªç™»å…¥');

  const btn = document.getElementById('btn-test-api');
  try {
    btn.disabled = true;
    btn.textContent = 'æ¸¬è©¦ä¸­...';

    // å„ªå…ˆæ¸¬è©¦ FMPï¼ˆå› ç‚ºä½ æœ‰ keyï¼‰
    const fmpKey = document.getElementById('input-fmp-key').value.trim();
    if (fmpKey) {
      const url = `https://financialmodelingprep.com/api/v3/quote/AAPL?apikey=${fmpKey}`;
      const res = await fetch(url);
      const data = await res.json();

      if (data && data.length > 0 && data[0].price) {
        alert(`âœ… FMP é€£æ¥æˆåŠŸï¼\næ¸¬è©¦è‚¡ç¥¨ï¼šAAPL\nç¾åƒ¹ï¼š$${data[0].price}`);
        return;
      } else if (data.Error) {
        alert('âŒ FMP éŒ¯èª¤ï¼š' + data['Error Message']);
        return;
      }
    }

    // å¦‚æœå†‡ FMP keyï¼Œè©¦ Alpha Vantage
    const alphaKey = document.getElementById('input-alpha-key').value.trim();
    if (alphaKey) {
      const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=AAPL&apikey=${alphaKey}`;
      const res = await fetch(url);
      const data = await res.json();

      if (data['Global Quote'] && data['Global Quote']['05. price']) {
        alert(`âœ… Alpha Vantage é€£æ¥æˆåŠŸï¼\næ¸¬è©¦è‚¡ç¥¨ï¼šAAPL\nç¾åƒ¹ï¼š$${data['Global Quote']['05. price']}`);
        return;
      } else if (data['Note']) {
        alert('âš ï¸ Alpha Vantage é€Ÿç‡é™åˆ¶ï¼š' + data['Note']);
        return;
      }
    }

    alert('âŒ è«‹å…ˆè¼¸å…¥è‡³å°‘ä¸€å€‹ API key');
  } catch (e) {
    alert('æ¸¬è©¦å¤±æ•—ï¼š' + (e.message || e));
  } finally {
    btn.disabled = false;
    btn.textContent = 'ğŸ§ª æ¸¬è©¦é€£æ¥ï¼ˆFMPï¼‰';
  }
}


function bindAPIConfig() {
  const btnSave = document.getElementById('btn-save-api-keys');
  const btnTest = document.getElementById('btn-test-api');

  if (btnSave && !btnSave.dataset.bound) {
    btnSave.dataset.bound = '1';
    btnSave.addEventListener('click', saveAPIKeys);
  }

  if (btnTest && !btnTest.dataset.bound) {
    btnTest.dataset.bound = '1';
    btnTest.addEventListener('click', testAPIConnection);
  }
}

// ===== Currency & Exchange Rate =====

// è²¨å¹£ç¬¦è™Ÿå°æ‡‰
const CURRENCY_SYMBOLS = {
  'USD': '$',
  'HKD': 'HK$',
  'CNY': 'Â¥',
  'JPY': 'Â¥',
  'TWD': 'NT$',
  'EUR': 'â‚¬',
  'GBP': 'Â£'
};

// ç²å–åŒ¯ç‡ï¼ˆæœ‰ cacheï¼Œ24 å°æ™‚å…§ä¸é‡è¤‡è«‹æ±‚ï¼‰
async function fetchExchangeRate(from, to) {
  if (from === to) return 1;

  const pair = from + to;
  const now = Date.now();

  // æª¢æŸ¥ cacheï¼ˆ24 å°æ™‚æœ‰æ•ˆï¼‰
  if (app.exchangeRates[pair] && app.exchangeRatesUpdated) {
    const age = now - app.exchangeRatesUpdated;
    if (age < 24 * 60 * 60 * 1000) {
      console.log(`âœ… ä½¿ç”¨ç·©å­˜åŒ¯ç‡ï¼š${pair} = ${app.exchangeRates[pair]}`);
      return app.exchangeRates[pair];
    }
  }

  // æ‹‰å–åŒ¯ç‡ï¼ˆç”¨ FMP APIï¼‰
try {
  // ç”¨å…è²»åŒ¯ç‡ APIï¼ˆä¸éœ€è¦ FMP keyï¼‰
  const url = `https://open.er-api.com/v6/latest/${from}`;
  const res = await fetch(url);
  const data = await res.json();

  if (data && data.rates && data.rates[to]) {
    const rate = data.rates[to];
    app.exchangeRates[pair] = rate;
    app.exchangeRatesUpdated = now;
    console.log(`ğŸ’± æ›´æ–°åŒ¯ç‡ï¼š${pair} = ${rate}`);
    return rate;
  } else {
    console.warn('âš ï¸ åŒ¯ç‡ API æ‹‰å–å¤±æ•—ï¼Œä½¿ç”¨å›ºå®šåŒ¯ç‡');
    const fallbackRates = {
      'USDHKD': 7.8,
      'USDCNY': 7.2,
      'USDJPY': 150,
      'USDTWD': 31.5,
      'USDEUR': 0.92,
      'USDGBP': 0.79
    };
    app.exchangeRates[pair] = fallbackRates[pair] || 1;
    return app.exchangeRates[pair];
  }
} catch (e) {
  console.error('åŒ¯ç‡æ‹‰å–éŒ¯èª¤:', e);
  const fallbackRates = {
    'USDHKD': 7.8,
    'USDCNY': 7.2,
    'USDJPY': 150,
    'USDTWD': 31.5,
    'USDEUR': 0.92,
    'USDGBP': 0.79
  };
  app.exchangeRates[pair] = fallbackRates[pair] || 1;
  return app.exchangeRates[pair];
}
 
}

// çµ±ä¸€æ ¼å¼åŒ–é‡‘é¡ï¼ˆè½‰æ› + é¡¯ç¤ºç¬¦è™Ÿï¼‰
async function formatCurrency(amount, skipConvert = false) {
  if (!app.user) return '$' + amount.toFixed(2);

  const displayCurrency = app.displayCurrency || 'HKD';
  const symbol = CURRENCY_SYMBOLS[displayCurrency] || displayCurrency;

  if (skipConvert || app.baseCurrency === displayCurrency) {
    return symbol + ' ' + amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
  }

  // è½‰æ›åŒ¯ç‡
  const rate = await fetchExchangeRate(app.baseCurrency, displayCurrency);
  const converted = amount * rate;

  return symbol + ' ' + converted.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// è¼‰å…¥ç”¨æˆ¶è²¨å¹£è¨­å®š
async function loadCurrencySetting() {
  if (!app.user) return;

  const { data } = await app.supabase
    .from('settings')
    .select('currency')
    .eq('user_id', app.user.id)
    .maybeSingle();

  app.displayCurrency = data?.currency || 'USD';;
  document.getElementById('select-currency').value = app.displayCurrency;
}

// ä¿å­˜è²¨å¹£è¨­å®š
async function saveCurrencySetting() {
  if (!app.user) return;

  const newCurrency = document.getElementById('select-currency').value;
  app.displayCurrency = newCurrency;

  const { error } = await app.supabase
    .from('settings')
    .upsert({
      user_id: app.user.id,
      currency: newCurrency,
      updated_at: new Date().toISOString()
    }, { onConflict: 'user_id' });

  if (error) {
    console.error('ä¿å­˜è²¨å¹£å¤±æ•—:', error);
    return;
  }

  // æ¸…é™¤åŒ¯ç‡ cacheï¼Œå¼·åˆ¶é‡æ–°æ‹‰å–
  app.exchangeRates = {};
  app.exchangeRatesUpdated = null;

  // é‡æ–°æ¸²æŸ“æ‰€æœ‰é¡¯ç¤º
  await loadHoldingsAndRender();
  await renderCharts();
  
  displayExchangeRates();  // âœ… åŠ å‘¢è¡Œï¼šæ›´æ–°åŒ¯ç‡åˆ—è¡¨é¡¯ç¤º
}



// ç¶å®šè²¨å¹£é¸æ“‡å™¨
function bindCurrencySelector() {
  const sel = document.getElementById('select-currency');
  if (sel && !sel.dataset.bound) {
    sel.dataset.bound = '1';
    sel.addEventListener('change', async () => {
      await saveCurrencySetting();
      alert('âœ… è²¨å¹£å·²åˆ‡æ›ï¼Œæ‰€æœ‰é‡‘é¡å·²æ›´æ–°');
    });
  }
}

// é¡¯ç¤ºåŒ¯ç‡åˆ—è¡¨ï¼ˆé¡¯ç¤ºæ‰€æœ‰æ”¯æ´è²¨å¹£å°ï¼‰
async function displayExchangeRates() {
  const tbody = document.getElementById('rates-table-body');
  const displayCurrencyName = document.getElementById('display-currency-name');
  const ratesUpdatedTime = document.getElementById('rates-updated-time');

  if (!tbody) return;

  displayCurrencyName.textContent = app.displayCurrency || 'HKD';

  if (app.exchangeRatesUpdated) {
    const d = new Date(app.exchangeRatesUpdated);
    const hh = String(d.getHours()).padStart(2, '0');
    const mm = String(d.getMinutes()).padStart(2, '0');
    ratesUpdatedTime.textContent = `${d.getMonth()+1}/${d.getDate()} ${hh}:${mm}`;
  } else {
    ratesUpdatedTime.textContent = 'æœªæ›´æ–°';
  }

  // é¡¯ç¤ºæ‰€æœ‰æ”¯æ´è²¨å¹£ï¼ˆå¾ USD è½‰æ›,å¦‚æœä½ æƒ³åŠ å¤šå•²è²¨å¹£ï¼ˆä¾‹å¦‚ SGD/AUD/CADï¼‰ï¼Œå¯ä»¥æ”¹å‘¢è¡Œï¼‰
  const targetCurrencies = ['HKD', 'CNY', 'JPY', 'TWD', 'EUR', 'GBP'];
  tbody.innerHTML = '';

  for (const to of targetCurrencies) {
    const pair = app.baseCurrency + to; // USDHKD
    const displayPair = `${app.baseCurrency}-${to}`; // USD-HKD
    
    // å¦‚æœæœªè¼‰å…¥ï¼Œå…ˆæ‹‰å–ï¼ˆä¸æœƒé˜»å¡ UIï¼‰
    let rate = app.exchangeRates[pair];
    if (!rate) {
      // éåŒæ­¥è¼‰å…¥ï¼ˆä¸ç­‰å¾…ï¼‰
      fetchExchangeRate(app.baseCurrency, to).then(r => {
        displayExchangeRates(); // è¼‰å…¥å®Œæˆå¾Œé‡æ–°æ¸²æŸ“
      });
      rate = 'è¼‰å…¥ä¸­...';
    }

    const source = (typeof rate === 'number' && app.exchangeRatesUpdated && Date.now() - app.exchangeRatesUpdated < 24*60*60*1000) 
      ? 'APIï¼ˆå¯¦æ™‚ï¼‰' 
      : (typeof rate === 'number' ? 'å›ºå®šå€¼' : '-');
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${displayPair}</strong></td>
      <td>${typeof rate === 'number' ? rate.toFixed(4) : rate}</td>
      <td style="font-size:11px; color:var(--muted);">${source}</td>
    `;
    tbody.appendChild(tr);
  }
}

// åŒ¯ç‡æ›ç®—
async function calculateExchange() {
  const amountInput = document.getElementById('calc-amount');
  const fromSelect = document.getElementById('calc-from');
  const toSelect = document.getElementById('calc-to');
  const resultDiv = document.getElementById('calc-result');

  if (!amountInput || !fromSelect || !toSelect || !resultDiv) return;

  const amount = Number(amountInput.value) || 0;
  const from = fromSelect.value;
  const to = toSelect.value;

  if (amount <= 0) {
    resultDiv.textContent = '-';
    return;
  }

  if (from === to) {
    const symbol = CURRENCY_SYMBOLS[to] || to;
    resultDiv.textContent = symbol + ' ' + amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    return;
  }

  try {
    // éœ€è¦å…©æ­¥è½‰æ›ï¼šfrom â†’ USD â†’ to
    let amountInUSD = amount;
    
    // 1) å¦‚æœä¾†æºä¸æ˜¯ USDï¼Œå…ˆè½‰æˆ USD
    if (from !== 'USD') {
      const rateToUSD = await fetchExchangeRate('USD', from);
      amountInUSD = amount / rateToUSD; // åå‘è¨ˆç®—
    }

    // 2) å†å¾ USD è½‰åˆ°ç›®æ¨™è²¨å¹£
    let result = amountInUSD;
    if (to !== 'USD') {
      const rateFromUSD = await fetchExchangeRate('USD', to);
      result = amountInUSD * rateFromUSD;
    }

    const symbol = CURRENCY_SYMBOLS[to] || to;
    resultDiv.textContent = symbol + ' ' + result.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    
  } catch (e) {
    console.error('æ›ç®—å¤±æ•—:', e);
    resultDiv.textContent = 'è¨ˆç®—å¤±æ•—';
  }
}

// ç¶å®šæ›ç®—å™¨äº‹ä»¶
function bindCalculator() {
  const amountInput = document.getElementById('calc-amount');
  const fromSelect = document.getElementById('calc-from');
  const toSelect = document.getElementById('calc-to');

  if (amountInput && !amountInput.dataset.bound) {
    amountInput.dataset.bound = '1';
    amountInput.addEventListener('input', calculateExchange);
  }

  if (fromSelect && !fromSelect.dataset.bound) {
    fromSelect.dataset.bound = '1';
    fromSelect.addEventListener('change', calculateExchange);
  }

  if (toSelect && !toSelect.dataset.bound) {
    toSelect.dataset.bound = '1';
    toSelect.addEventListener('change', calculateExchange);
  }
}

// ===== Reset Settings =====
async function resetAllSettings() {
  if (!app.user) return alert('âŒ æœªç™»å…¥');

  // äºŒæ¬¡ç¢ºèª
  if (!confirm('âš ï¸ ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¨­å®šä¸¦é‡ç½®ç‚ºé»˜èªå€¼ï¼Ÿ\n\næ­¤æ“ä½œæœƒæ¸…é™¤ï¼š\n- æ‰€æœ‰ API é‡‘é‘°\n- ç¨…ç‡/ç„¡é¢¨éšªåˆ©ç‡\n- åˆ·æ–°é »ç‡\n- é¡¯ç¤ºè²¨å¹£\n\næŒå€‰æ•¸æ“šä¸å—å½±éŸ¿ã€‚')) {
    return;
  }

  if (!confirm('ğŸš¨ æœ€å¾Œç¢ºèªï¼šçœŸçš„è¦æ¸…é™¤æ‰€æœ‰è¨­å®šå—ï¼Ÿ')) {
    return;
  }

  const btn = document.getElementById('btn-reset-settings');
  
  try {
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'æ¸…é™¤ä¸­...';
    }

    // åˆªé™¤ settings è¨˜éŒ„
    const { error } = await app.supabase
      .from('settings')
      .delete()
      .eq('user_id', app.user.id);

    if (error) throw error;

    // æ¸…é™¤å‰ç«¯ cache
    app.displayCurrency = 'USD';
    app.exchangeRates = {};
    app.exchangeRatesUpdated = null;

    // æ¸…é™¤å®šæ™‚å™¨
    if (app.refreshTimer) {
      clearInterval(app.refreshTimer);
      app.refreshTimer = null;
    }

    alert('âœ… è¨­å®šå·²æ¸…é™¤ï¼Œé é¢å³å°‡é‡æ–°è¼‰å…¥');

    // é‡æ–°è¼‰å…¥é é¢
    window.location.reload();

  } catch (e) {
    console.error('é‡ç½®å¤±æ•—:', e);
    alert('é‡ç½®å¤±æ•—ï¼š' + (e.message || e));
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è¨­å®šä¸¦é‡ç½®';
    }
  }
}

// ç¶å®šé‡ç½®æŒ‰éˆ•
function bindResetSettings() {
  const btn = document.getElementById('btn-reset-settings');
  if (btn && !btn.dataset.bound) {
    btn.dataset.bound = '1';
    btn.addEventListener('click', resetAllSettings);
  }
}

// ===== Portfolio Management =====

// è¼‰å…¥ç”¨æˆ¶æ‰€æœ‰ portfolios
async function loadPortfolios() {
  if (!app.user) return;

  const { data, error } = await app.supabase
    .from('portfolios')
    .select('id, portfolio_name, created_at')
    .eq('user_id', app.user.id)
    .order('created_at', { ascending: true });

  if (error) {
    console.error('è¼‰å…¥ portfolios å¤±æ•—:', error);
    return;
  }

  app.portfolios = data || [];

  // æ¸²æŸ“ dropdown
  const selector = document.getElementById('portfolio-selector');
  if (!selector) return;

  selector.innerHTML = '';

  if (app.portfolios.length === 0) {
    // å¦‚æœæ²’æœ‰ï¼Œè‡ªå‹•å»ºä¸€å€‹
    const defaultId = await ensureDefaultPortfolio(app.user.id);
    app.currentPortfolioId = defaultId;
    await loadPortfolios(); // é‡æ–°è¼‰å…¥
    return;
  }

  app.portfolios.forEach(p => {
    const option = document.createElement('option');
    option.value = p.id;
    option.textContent = p.portfolio_name || 'Untitled Portfolio';
    selector.appendChild(option);
  });

  // é»˜èªé¸ç¬¬ä¸€å€‹
  if (!app.currentPortfolioId && app.portfolios.length > 0) {
    app.currentPortfolioId = app.portfolios[0].id;
  }

  selector.value = app.currentPortfolioId;
}

// åˆ‡æ› portfolio
async function switchPortfolio(portfolioId) {
  if (!portfolioId || portfolioId === app.currentPortfolioId) return;

  app.currentPortfolioId = portfolioId;
  console.log('ğŸ”„ åˆ‡æ›åˆ° portfolio:', portfolioId);

  // é‡æ–°è¼‰å…¥æ‰€æœ‰æ•¸æ“š
  await loadHoldingsAndRender();
  await renderCharts();
}

// ç¶å®š portfolio selector
function bindPortfolioSelector() {
  const selector = document.getElementById('portfolio-selector');
  if (selector && !selector.dataset.bound) {
    selector.dataset.bound = '1';
    selector.addEventListener('change', async () => {
      await switchPortfolio(selector.value);
    });
  }
}

// Portfolio ç®¡ç† Modalï¼ˆæ–°å¢/åˆªé™¤/é‡å‘½åï¼‰
// ===== Portfolio Manager Modal =====

function openPortfolioManager() {
  document.getElementById('portfolioModal').style.display = 'flex';
  renderPortfolioList();
}

function closePortfolioManager() {
  document.getElementById('portfolioModal').style.display = 'none';
  document.getElementById('input-new-portfolio-name').value = '';
}

// æ¸²æŸ“ portfolio åˆ—è¡¨
function renderPortfolioList() {
  const container = document.getElementById('portfolio-list');
  if (!container) return;

  container.innerHTML = '';

  if (app.portfolios.length === 0) {
    container.innerHTML = '<p style="text-align:center; color:var(--muted); padding:20px;">æš«ç„¡çµ„åˆ</p>';
    return;
  }

  app.portfolios.forEach(p => {
    const isActive = p.id === app.currentPortfolioId;
    
    const item = document.createElement('div');
    item.style.cssText = `
      display:flex; 
      align-items:center; 
      justify-content:space-between; 
      padding:10px 12px; 
      margin-bottom:8px; 
      border-radius:8px; 
      background:${isActive ? 'rgba(59,130,246,0.15)' : 'rgba(15,23,42,0.95)'};
      border:1px solid ${isActive ? 'rgba(59,130,246,0.4)' : 'rgba(31,41,55,0.9)'};
    `;

    item.innerHTML = `
      <div style="flex:1;">
        <div style="font-size:13px; font-weight:${isActive ? '600' : '400'}; color:${isActive ? '#e5e7eb' : '#9ca3af'};">
          ${p.portfolio_name || 'Untitled Portfolio'}
          ${isActive ? '<span style="font-size:11px; margin-left:6px; color:#22c55e;">ï¼ˆç•¶å‰ï¼‰</span>' : ''}
        </div>
        <div style="font-size:11px; color:#6b7280; margin-top:2px;">
          å»ºç«‹æ–¼ï¼š${new Date(p.created_at).toLocaleDateString('zh-HK')}
        </div>
      </div>
      
      <div style="display:flex; gap:6px;">
        <button class="btn btn-outline" style="font-size:11px; padding:4px 8px;" data-rename="${p.id}">
          âœï¸ é‡å‘½å
        </button>
        <button class="btn btn-outline" style="font-size:11px; padding:4px 8px; color:var(--danger); border-color:var(--danger);" data-delete="${p.id}">
          ğŸ—‘ï¸ åˆªé™¤
        </button>
      </div>
    `;

    container.appendChild(item);
  });

  // ç¶å®šäº‹ä»¶ï¼ˆäº‹ä»¶å§”æ´¾ï¼‰
  container.querySelectorAll('[data-rename]').forEach(btn => {
    btn.addEventListener('click', () => renamePortfolio(btn.dataset.rename));
  });

  container.querySelectorAll('[data-delete]').forEach(btn => {
    btn.addEventListener('click', () => deletePortfolio(btn.dataset.delete));
  });
}

// æ–°å¢ portfolio
async function createPortfolio() {
  if (!app.user) return;

  const input = document.getElementById('input-new-portfolio-name');
  const name = input.value.trim();

  if (!name) {
    alert('è«‹è¼¸å…¥çµ„åˆåç¨±');
    return;
  }

  try {
    const { error } = await app.supabase
      .from('portfolios')
      .insert([{
        user_id: app.user.id,
        portfolio_name: name
      }]);

    if (error) throw error;

    alert('âœ… çµ„åˆå·²æ–°å¢');
    input.value = '';
    
    await loadPortfolios(); // é‡æ–°è¼‰å…¥
    renderPortfolioList();  // åˆ·æ–°åˆ—è¡¨
  } catch (e) {
    console.error('æ–°å¢ portfolio å¤±æ•—:', e);
    alert('æ–°å¢å¤±æ•—ï¼š' + (e.message || e));
  }
}

// é‡å‘½å portfolio
async function renamePortfolio(id) {
  if (!app.user) return;

  const portfolio = app.portfolios.find(p => p.id === id);
  if (!portfolio) return;

  const newName = prompt('è¼¸å…¥æ–°åç¨±ï¼š', portfolio.portfolio_name);
  if (!newName || newName.trim() === '') return;

  try {
    const { error } = await app.supabase
      .from('portfolios')
      .update({ portfolio_name: newName.trim() })
      .eq('id', id)
      .eq('user_id', app.user.id);

    if (error) throw error;

    alert('âœ… å·²é‡å‘½å');
    
    await loadPortfolios();
    renderPortfolioList();
  } catch (e) {
    console.error('é‡å‘½åå¤±æ•—:', e);
    alert('é‡å‘½åå¤±æ•—ï¼š' + (e.message || e));
  }
}

// åˆªé™¤ portfolio
async function deletePortfolio(id) {
  if (!app.user) return;

  const portfolio = app.portfolios.find(p => p.id === id);
  if (!portfolio) return;

  // æª¢æŸ¥æ˜¯å¦æœ‰æŒå€‰
  const { data: holdings } = await app.supabase
    .from('holdings')
    .select('id')
    .eq('user_id', app.user.id)
    .eq('portfolio_id', id);

  const hasHoldings = holdings && holdings.length > 0;

  let confirmMsg = `ç¢ºå®šè¦åˆªé™¤çµ„åˆã€Œ${portfolio.portfolio_name}ã€å—ï¼Ÿ`;
  if (hasHoldings) {
    confirmMsg += `\n\nâš ï¸ æ­¤çµ„åˆæœ‰ ${holdings.length} ç­†æŒå€‰ï¼Œåˆªé™¤å¾ŒæœƒåŒæ™‚æ¸…é™¤æ‰€æœ‰æŒå€‰å’Œå¿«ç…§ï¼`;
  }

  if (!confirm(confirmMsg)) return;
  if (hasHoldings && !confirm('ğŸš¨ æœ€å¾Œç¢ºèªï¼šçœŸçš„è¦åˆªé™¤æ­¤çµ„åˆåŠæ‰€æœ‰æŒå€‰å—ï¼Ÿ')) return;

  try {
    // Supabase æœƒè‡ªå‹•ç´šè¯åˆªé™¤ï¼ˆå› ç‚ºä½ æœ‰ on delete cascadeï¼‰
    const { error } = await app.supabase
      .from('portfolios')
      .delete()
      .eq('id', id)
      .eq('user_id', app.user.id);

    if (error) throw error;

    alert('âœ… çµ„åˆå·²åˆªé™¤');

    // å¦‚æœåˆªé™¤çš„æ˜¯ç•¶å‰ portfolioï¼Œåˆ‡æ›åˆ°ç¬¬ä¸€å€‹
    if (id === app.currentPortfolioId) {
      app.currentPortfolioId = null;
    }

    await loadPortfolios();
    renderPortfolioList();
    
    // åˆ·æ–° holdings
    await loadHoldingsAndRender();
    await renderCharts();

  } catch (e) {
    console.error('åˆªé™¤å¤±æ•—:', e);
    alert('åˆªé™¤å¤±æ•—ï¼š' + (e.message || e));
  }
}

function bindPortfolioManager() {
  const btnManage = document.getElementById('btn-manage-portfolios');
  const btnClose = document.getElementById('btnClosePortfolioModal');
  const btnCreate = document.getElementById('btn-create-portfolio');

  if (btnManage && !btnManage.dataset.bound) {
    btnManage.dataset.bound = '1';
    btnManage.addEventListener('click', openPortfolioManager);
  }

  if (btnClose && !btnClose.dataset.bound) {
    btnClose.dataset.bound = '1';
    btnClose.addEventListener('click', closePortfolioManager);
  }

  if (btnCreate && !btnCreate.dataset.bound) {
    btnCreate.dataset.bound = '1';
    btnCreate.addEventListener('click', createPortfolio);
  }

  // Enter éµå¿«æ·æ–°å¢
  const input = document.getElementById('input-new-portfolio-name');
  if (input && !input.dataset.bound) {
    input.dataset.bound = '1';
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') createPortfolio();
    });
  }
}

// ===== Portfolio Overview (è·¨çµ„åˆç¸½è¦½) =====

async function loadPortfolioOverview() {
  console.log('ğŸ”µ loadPortfolioOverview START, portfolios:', app.portfolios.length);
  if (!app.user || app.portfolios.length === 0) {
    console.log('âš ï¸ æ²’æœ‰ç”¨æˆ¶æˆ–çµ„åˆ');
    return;
  }
  try {
    let grandTotalValue = 0;
    let grandTotalGain = 0;
    let grandHoldingsCount = 0;

    const tableData = [];

    // é€å€‹ portfolio æ‹‰æ•¸æ“š
    for (const p of app.portfolios) {
      const { data: holdings } = await app.supabase
        .from('holdings')
        .select('current_value, gain')
        .eq('user_id', app.user.id)
        .eq('portfolio_id', p.id);

      let pValue = 0;
      let pGain = 0;

      if (holdings && holdings.length > 0) {
        holdings.forEach(h => {
          pValue += Number(h.current_value || 0);
          pGain += Number(h.gain || 0);
        });
      }

      const pCost = pValue - pGain;
      const pGainPct = pCost > 0 ? (pGain / pCost * 100) : 0;

      grandTotalValue += pValue;
      grandTotalGain += pGain;
      grandHoldingsCount += (holdings ? holdings.length : 0);

      tableData.push({
        id: p.id,
        name: p.portfolio_name,
        value: pValue,
        gain: pGain,
        gainPct: pGainPct,
        count: holdings ? holdings.length : 0
      });
    }

    // æ›´æ–°ç¸½è³‡ç”¢å¡ç‰‡
    const totalAssetsStr = await formatCurrency(grandTotalValue);
    const totalGainStr = await formatCurrency(grandTotalGain);
    const grandCost = grandTotalValue - grandTotalGain;
    const grandGainPct = grandCost > 0 ? (grandTotalGain / grandCost * 100) : 0;

    document.getElementById('overview-total-assets').textContent = totalAssetsStr;
    document.getElementById('overview-total-gain').textContent = totalGainStr;
    document.getElementById('overview-total-gain-pct').textContent = grandGainPct.toFixed(2) + '%';
    document.getElementById('overview-total-gain-pct').className = 'metric-change ' + (grandGainPct >= 0 ? 'up' : '');
    document.getElementById('overview-portfolios-count').textContent = `åŒ…å« ${app.portfolios.length} å€‹çµ„åˆ`;
    document.getElementById('overview-holdings-count').textContent = grandHoldingsCount;

    // æ¸²æŸ“å°æ¯”è¡¨
    renderPortfolioComparisonTable(tableData, grandTotalValue);

    // æ¸²æŸ“åœ–è¡¨
    renderPortfolioPieChart(tableData);
await renderPortfolioLinesChart();

  } catch (e) {
    console.error('loadPortfolioOverview error:', e);
  }
}

// æ¸²æŸ“å°æ¯”è¡¨
async function renderPortfolioComparisonTable(data, grandTotal) {
  const tbody = document.getElementById('portfolio-comparison-tbody');
  if (!tbody) return;

  tbody.innerHTML = '';

  if (data.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:var(--muted); padding:20px;">æš«ç„¡çµ„åˆ</td></tr>';
    return;
  }

  for (const p of data) {
    const valueStr = await formatCurrency(p.value);
    const gainStr = await formatCurrency(p.gain);
    const percentage = grandTotal > 0 ? ((p.value / grandTotal) * 100).toFixed(1) : 0;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${p.name}</strong></td>
      <td>${valueStr}</td>
      <td style="color:${p.gain >= 0 ? '#4ade80' : '#ef4444'}"><strong>${gainStr}</strong></td>
      <td style="color:${p.gainPct >= 0 ? '#4ade80' : '#ef4444'}"><strong>${p.gainPct.toFixed(2)}%</strong></td>
      <td>${p.count}</td>
      <td>${percentage}%</td>
      <td>
        <button class="btn btn-outline" style="font-size:11px; padding:4px 8px;" data-switch="${p.id}">
          åˆ‡æ›
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  }

  // ç¶å®šåˆ‡æ›æŒ‰éˆ•
  tbody.querySelectorAll('[data-switch]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const portfolioId = btn.dataset.switch;
      
      // åˆ‡æ› portfolio
      app.currentPortfolioId = portfolioId;
      document.getElementById('portfolio-selector').value = portfolioId;
      
      // è¿”å›å„€è¡¨æ¿
      switchPage('dashboard');
      
      // åˆ·æ–°æ•¸æ“š
      await loadHoldingsAndRender();
      await renderCharts();
    });
  });
}

// è³‡ç”¢åˆ†ä½ˆé¤…åœ–ï¼ˆæŒ‰çµ„åˆï¼‰
function renderPortfolioPieChart(data) {
  const ctx = document.getElementById('chartPortfolioPie');
  if (!ctx) return;

  if (app.chartPortfolioPie) {
    app.chartPortfolioPie.destroy();
  }

  if (data.length === 0) return;

  const labels = data.map(p => p.name);
  const values = data.map(p => p.value);
  const colors = ['#3b82f6', '#22c55e', '#eab308', '#ef4444', '#8b5cf6', '#ec4899'];

  app.chartPortfolioPie = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: colors.slice(0, labels.length),
        borderColor: '#020617',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: { color: '#e5e7eb', font: { size: 11 } }
        },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const label = ctx.label || '';
              const value = ctx.parsed || 0;
              const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
              const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
              
              const displayCurrency = app.displayCurrency || 'USD';
              const symbol = CURRENCY_SYMBOLS[displayCurrency] || displayCurrency;
              const pair = app.baseCurrency + displayCurrency;
              const rate = app.exchangeRates[pair] || 1;
              const converted = value * rate;
              
              return `${label}: ${symbol} ${converted.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} (${pct}%)`;
            }
          }
        }
      }
    }
  });
}
async function renderPortfolioLinesChart() {
  const canvas = document.getElementById("chartPortfolioLines");
  if (!canvas) return;

  // æ¸…æ‰èˆŠåœ–
  if (app.chartPortfolioLines) {
    app.chartPortfolioLines.destroy();
    app.chartPortfolioLines = null;
  }

  if (!app.user || !app.portfolios || app.portfolios.length === 0) return;

  // è¿‘ 30 æ—¥ï¼ˆç”¨ YYYY-MM-DD å­—ä¸²ï¼‰
  const start = new Date();
  start.setDate(start.getDate() - 29);
  const startDate = start.toISOString().slice(0, 10);

  // å…ˆç®—ä¸€æ¬¡åŒ¯ç‡ï¼ˆsnapshots çš„ totalvalue ä¿‚ baseCurrencyï¼›é¡¯ç¤ºç”¨ displayCurrencyï¼‰
  const displayCurrency = app.displayCurrency || "USD";
  const symbol = (typeof CURRENCY_SYMBOLS !== "undefined" && CURRENCY_SYMBOLS[displayCurrency]) ? CURRENCY_SYMBOLS[displayCurrency] : displayCurrency;
  const rate = await fetchExchangeRate(app.baseCurrency || "USD", displayCurrency);

  // æ‹‰æ‰€æœ‰ portfolios å„è‡ª snapshotsï¼ˆæœ€å¤š 30 ç­†ï¼‰
  const byPortfolio = [];
  const dateSet = new Set();

  for (const p of app.portfolios) {
    const { data: rows, error } = await app.supabase
      .from("portfoliosnapshots")
      .select("snapshotdate,totalvalue")
      .eq("userid", app.user.id)
      .eq("portfolioid", p.id)
      .gte("snapshotdate", startDate)
      .order("snapshotdate", { ascending: true })
      .limit(30);

    if (error) {
      console.error("renderPortfolioLinesChart snapshots error:", error);
      continue;
    }

    const map = new Map();
    (rows || []).forEach(r => {
      const d = r.snapshotdate; // YYYY-MM-DD
      dateSet.add(d);
      const v = Number(r.totalvalue || 0) * (rate || 1);
      map.set(d, v);
    });

    byPortfolio.push({ name: p.portfolioname || "Untitled", map });
  }

  const labelsISO = Array.from(dateSet).sort(); // YYYY-MM-DD
  if (labelsISO.length === 0) {
    // ç„¡å¿«ç…§å°±å””ç•«ï¼ˆä½ äº¦å¯ä»¥æ”¹æˆé¡¯ç¤º placeholderï¼‰
    return;
  }

  const labels = labelsISO.map(s => {
    const d = new Date(s);
    return `${d.getMonth() + 1}/${d.getDate()}`;
  });

  const palette = ["#3b82f6","#22c55e","#eab308","#ef4444","#8b5cf6","#ec4899","#06b6d4","#f97316","#10b981","#6366f1"];

  const datasets = byPortfolio.map((p, idx) => {
    const data = labelsISO.map(d => (p.map.has(d) ? p.map.get(d) : null)); // ç¼ºæ—¥å­ç”¨ null
    return {
      label: p.name,
      data,
      borderColor: palette[idx % palette.length],
      backgroundColor: "transparent",
      borderWidth: 2,
      tension: 0.25,
      pointRadius: 2,
      pointHoverRadius: 5,
      spanGaps: false
    };
  });

  app.chartPortfolioLines = new Chart(canvas, {
    type: "line",
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { position: "bottom", labels: { color: "#e5e7eb", font: { size: 11 } } },
        tooltip: {
          mode: "index",
          intersect: false,
          callbacks: {
            label: (ctx) => {
              const v = ctx.parsed.y;
              if (v === null || typeof v === "undefined") return `${ctx.dataset.label}: -`;
              return `${ctx.dataset.label}: ${symbol} ${Number(v).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }
          }
        }
      },
      scales: {
        x: { ticks: { color: "#9ca3af", font: { size: 10 } }, grid: { color: "#1f2937" } },
        y: {
          ticks: {
            color: "#9ca3af",
            font: { size: 10 },
            callback: (value) => `${symbol}${Number(value).toLocaleString("en-US")}`
          },
          grid: { color: "#1f2937" }
        }
      }
    }
  });
}


// ===== Batch Update Prices =====

// å»¶é²å‡½æ•¸ï¼ˆç”¨æ–¼é€Ÿç‡æ§åˆ¶ï¼‰
function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// ç”¨ Alpha Vantage æ‹‰å–®ä¸€è‚¡ç¥¨åƒ¹æ ¼
async function fetchStockPrice(symbol, apiKey) {
  const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${apiKey}`;
  const res = await fetch(url);
  const data = await res.json();

  if (data['Global Quote'] && data['Global Quote']['05. price']) {
    return Number(data['Global Quote']['05. price']);
  } else if (data['Note']) {
    throw new Error('API é€Ÿç‡é™åˆ¶ï¼š' + data['Note']);
  } else if (data['Error Message']) {
    throw new Error(data['Error Message']);
  } else {
    throw new Error('ç„¡æ³•å–å¾—åƒ¹æ ¼');
  }
}

// æ‰¹é‡æ›´æ–°æ‰€æœ‰æŒå€‰ç¾åƒ¹
async function updateAllPrices() {
  if (!app.user) return alert('âŒ æœªç™»å…¥');

  const btn = document.getElementById('btnUpdatePrices');
  
  try {
    // 1) å–å¾— API key
    const { data: settings } = await app.supabase
      .from('settings')
      .select('alpha_vantage_key')
      .eq('user_id', app.user.id)
      .maybeSingle();

    const apiKey = settings?.alpha_vantage_key;
    if (!apiKey) {
      alert('âŒ è«‹å…ˆåœ¨ã€ŒğŸ”‘ API é…ç½®ã€è¨­ç½® Alpha Vantage API key');
      return;
    }

    // 2) å–å¾—æ‰€æœ‰æŒå€‰
const portfolioId = app.currentPortfolioId || await ensureDefaultPortfolio(app.user.id);
    const { data: holdings } = await app.supabase
      .from('holdings')
      .select('id, symbol, quantity, cost_price')
      .eq('user_id', app.user.id)
      .eq('portfolio_id', portfolioId);

    if (!holdings || holdings.length === 0) {
      alert('âŒ æ²’æœ‰æŒå€‰éœ€è¦æ›´æ–°');
      return;
    }

    const total = holdings.length;
    let updated = 0;
    let failed = 0;

    if (btn) {
      btn.disabled = true;
      btn.textContent = `æ›´æ–°ä¸­ 0/${total}`;
    }

    // 3) é€å€‹æ›´æ–°ï¼ˆæ¯æ¬¡é–“éš” 12 ç§’ï¼Œé¿å…è¶…é€Ÿç‡é™åˆ¶ï¼‰
    for (const h of holdings) {
      try {
        const newPrice = await fetchStockPrice(h.symbol, apiKey);
        
        // è¨ˆç®—æ–°çš„ current_value / gain / gain_percent
        const qty = Number(h.quantity || 0);
        const cost = Number(h.cost_price || 0);
        const currentValue = qty * newPrice;
        const totalCost = qty * cost;
        const gain = currentValue - totalCost;
        const gainPercent = totalCost > 0 ? (gain / totalCost * 100) : 0;

        // æ›´æ–°åˆ° DB
        const { error } = await app.supabase
          .from('holdings')
          .update({
            current_price: newPrice,
            current_value: currentValue,
            gain: gain,
            gain_percent: gainPercent
          })
          .eq('id', h.id)
          .eq('user_id', app.user.id);

        if (error) throw error;

        updated++;
        console.log(`âœ… ${h.symbol}: $${newPrice}`);

      } catch (e) {
        console.error(`âŒ ${h.symbol} æ›´æ–°å¤±æ•—:`, e.message);
        failed++;
      }

      // æ›´æ–°æŒ‰éˆ•é€²åº¦
      if (btn) {
        btn.textContent = `æ›´æ–°ä¸­ ${updated + failed}/${total}`;
      }

      // Alpha Vantage å…è²»ç‰ˆï¼š5 calls/min = æ¯ 12 ç§’ä¸€æ¬¡
      // å¦‚æœä¸æ˜¯æœ€å¾Œä¸€å€‹ï¼Œç­‰å¾… 12 ç§’
      if (updated + failed < total) {
        await delay(12000);
      }
    }

    // 4) å®Œæˆå¾Œåˆ·æ–° UI
    await loadHoldingsAndRender();
    await renderCharts();

    alert(`âœ… æ›´æ–°å®Œæˆ\næˆåŠŸï¼š${updated}\nå¤±æ•—ï¼š${failed}`);

  } catch (e) {
    console.error('æ‰¹é‡æ›´æ–°å¤±æ•—:', e);
    alert('æ›´æ–°å¤±æ•—ï¼š' + (e.message || e));
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'ğŸ’¹ æ›´æ–°æ‰€æœ‰ç¾åƒ¹';
    }
  }
}

// éœé»˜æ›´æ–°ï¼ˆçµ¦è‡ªå‹•åˆ·æ–°ç”¨ï¼Œä¸å½ˆ alertï¼‰
async function updateAllPricesQuiet() {
  if (!app.user) return;

  try {
    const { data: settings } = await app.supabase
      .from('settings')
      .select('alpha_vantage_key')
      .eq('user_id', app.user.id)
      .maybeSingle();

    const apiKey = settings?.alpha_vantage_key;
    if (!apiKey) {
      console.warn('âš ï¸ æœªè¨­ç½® Alpha Vantage keyï¼Œè·³éåƒ¹æ ¼æ›´æ–°');
      return;
    }

const portfolioId = app.currentPortfolioId || await ensureDefaultPortfolio(app.user.id);
    const { data: holdings } = await app.supabase
      .from('holdings')
      .select('id, symbol, quantity, cost_price')
      .eq('user_id', app.user.id)
      .eq('portfolio_id', portfolioId);

    if (!holdings || holdings.length === 0) return;

    const total = holdings.length;
    let updated = 0;

    for (const h of holdings) {
      try {
        const newPrice = await fetchStockPrice(h.symbol, apiKey);
        
        const qty = Number(h.quantity || 0);
        const cost = Number(h.cost_price || 0);
        const currentValue = qty * newPrice;
        const totalCost = qty * cost;
        const gain = currentValue - totalCost;
        const gainPercent = totalCost > 0 ? (gain / totalCost * 100) : 0;

        await app.supabase
          .from('holdings')
          .update({
            current_price: newPrice,
            current_value: currentValue,
            gain: gain,
            gain_percent: gainPercent
          })
          .eq('id', h.id)
          .eq('user_id', app.user.id);

        updated++;
        console.log(`âœ… ${h.symbol}: $${newPrice}`);

      } catch (e) {
        console.error(`âŒ ${h.symbol}:`, e.message);
      }

      // Alpha Vantage é€Ÿç‡æ§åˆ¶ï¼šæ¯ 12 ç§’ä¸€æ¬¡
      if (updated < total) {
        await delay(12000);
      }
    }

    console.log(`ğŸ’¹ åƒ¹æ ¼æ›´æ–°å®Œæˆï¼š${updated}/${total}`);

  } catch (e) {
    console.error('updateAllPricesQuiet error:', e);
  }
}


// ç¶å®šæŒ‰éˆ•
function bindUpdatePrices() {
  const btn = document.getElementById('btnUpdatePrices');
  if (btn && !btn.dataset.bound) {
    btn.dataset.bound = '1';
    btn.addEventListener('click', updateAllPrices);
  }
}


// æ‰‹å‹•åˆ·æ–°åŒ¯ç‡
async function refreshExchangeRates() {
  const btn = document.getElementById('btn-refresh-rates');
  
  try {
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'åˆ·æ–°ä¸­...';
    }

    // æ¸…é™¤ cache
    app.exchangeRates = {};
    app.exchangeRatesUpdated = null;

    // é‡æ–°æ‹‰å–ç•¶å‰é¡¯ç¤ºè²¨å¹£çš„åŒ¯ç‡
    const displayCurrency = app.displayCurrency || 'HKD';
    if (displayCurrency !== app.baseCurrency) {
      await fetchExchangeRate(app.baseCurrency, displayCurrency);
    }

    // æ›´æ–°é¡¯ç¤º
    displayExchangeRates();
    
    alert('âœ… åŒ¯ç‡å·²æ›´æ–°');
  } catch (e) {
    console.error('åˆ·æ–°åŒ¯ç‡å¤±æ•—:', e);
    alert('åˆ·æ–°å¤±æ•—ï¼š' + (e.message || e));
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'ğŸ”„ åˆ·æ–°åŒ¯ç‡';
    }
  }
}

// ç¶å®šåˆ·æ–°æŒ‰éˆ•
function bindRatesDisplay() {
  const btn = document.getElementById('btn-refresh-rates');
  if (btn && !btn.dataset.bound) {
    btn.dataset.bound = '1';
    btn.addEventListener('click', refreshExchangeRates);
  }
}


// ===== Charts =====
app.chartPie = null;
app.chartLine = null;

function renderCharts() {
  renderPieChart();
  renderLineChart();
}

async function renderPieChart() {
  if (!app.user) return;

const portfolioId = app.currentPortfolioId || await ensureDefaultPortfolio(app.user.id);

  const { data: rows } = await app.supabase
  .from('holdings')
  .select('symbol, current_value')
  .eq('user_id', app.user.id)
  .eq('portfolio_id', portfolioId);


  if (!rows || rows.length === 0) {
    destroyChart('chartPie');
    return;
  }

  const labels = [];
  const data = [];
  const colors = [
    '#3b82f6', '#22c55e', '#eab308', '#ef4444', '#8b5cf6',
    '#ec4899', '#06b6d4', '#f97316', '#10b981', '#6366f1'
  ];

  rows.forEach(r => {
    labels.push((r.symbol || '').toUpperCase());
    data.push(Number(r.current_value || 0));
  });

  const ctx = document.getElementById('chartPie');
  if (!ctx) return;

  destroyChart('chartPie');

  app.chartPie = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: colors.slice(0, labels.length),
        borderColor: '#020617',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: { color: '#e5e7eb', font: { size: 11 } }
        },
tooltip: {
  callbacks: {
    label: function(ctx) {
      const label = ctx.label || '';
      const value = ctx.parsed || 0;
      const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
      const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
      
      // âœ… åŒæ­¥è½‰æ›
      const displayCurrency = app.displayCurrency || 'HKD';
      const symbol = CURRENCY_SYMBOLS[displayCurrency] || displayCurrency;
      const pair = app.baseCurrency + displayCurrency;
      const rate = app.exchangeRates[pair] || 1;
      const converted = value * rate;
      
      return `${label}: ${symbol} ${converted.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} (${pct}%)`;
    }
  }
}


      }
    }
  });
}

async function renderLineChart() {
  if (!app.user) return;

  try {
const portfolioId = app.currentPortfolioId || await ensureDefaultPortfolio(app.user.id);

    // è®€å–æœ€è¿‘ 30 æ—¥å¿«ç…§
    const { data: snapshots } = await app.supabase
      .from('portfolio_snapshots')
      .select('snapshot_date, total_value')
      .eq('user_id', app.user.id)
      .eq('portfolio_id', portfolioId)
      .order('snapshot_date', { ascending: true })
      .limit(30);

    const labels = [];
    const data = [];

    if (!snapshots || snapshots.length === 0) {
      // å¦‚æœå†‡æ­·å²æ•¸æ“šï¼Œç”¨æ¨¡æ“¬æ•¸æ“šï¼ˆ30 æ—¥ï¼‰
      const today = new Date();
      const totalAssetsText = document.getElementById('totalAssets')?.textContent || 'HK$ 0';
      const totalAssets = Number(totalAssetsText.replace(/[^\d.-]/g, '')) || 10000;

      for (let i = 29; i >= 0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        labels.push(`${d.getMonth() + 1}/${d.getDate()}`);
        
        const variation = (Math.random() - 0.5) * 0.06;
        const val = totalAssets * (1 + variation * (i / 30));
        data.push(val);
      }
      data[data.length - 1] = totalAssets;
    } else {
  // âœ… ä½¿ç”¨çœŸå¯¦å¿«ç…§æ•¸æ“šï¼ˆè¦è½‰æ›ï¼‰
  const displayCurrency = app.displayCurrency || 'HKD';
  const pair = app.baseCurrency + displayCurrency;
  const rate = app.exchangeRates[pair] || 1;
  
  snapshots.forEach(s => {
    const d = new Date(s.snapshot_date);
    labels.push(`${d.getMonth() + 1}/${d.getDate()}`);
    
    const valueUSD = Number(s.total_value || 0);
    const converted = valueUSD * rate;  // âœ… è½‰æ›
    data.push(converted);
  });
}

    const ctx = document.getElementById('chartLine');
    if (!ctx) return;

    destroyChart('chartLine');

    app.chartLine = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'ç¸½è³‡ç”¢ (HK$)',
          data: data,
          borderColor: '#22c55e',
          backgroundColor: 'rgba(34, 197, 94, 0.1)',
          borderWidth: 2,
          tension: 0.3,
          fill: true,
          pointRadius: 2,
          pointHoverRadius: 5,
          pointBackgroundColor: '#22c55e'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          tooltip: {
  mode: 'index',
  intersect: false,
  callbacks: {
    label: function(ctx) {
      const displayCurrency = app.displayCurrency || 'HKD';
      const symbol = CURRENCY_SYMBOLS[displayCurrency] || displayCurrency;
      return `ç¸½è³‡ç”¢: ${symbol} ${ctx.parsed.y.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }
  }
}

        },
        scales: {
  x: {
    ticks: { color: '#9ca3af', font: { size: 10 } },
    grid: { color: '#1f2937' }
  },
  y: {
    ticks: {
      color: '#9ca3af',
      font: { size: 10 },
      callback: function(value) {
        const displayCurrency = app.displayCurrency || 'HKD';
        const symbol = CURRENCY_SYMBOLS[displayCurrency] || displayCurrency;
        return symbol + ' ' + value.toLocaleString();
      }
    },
    grid: { color: '#1f2937' }
  }
}

      }
    });
  } catch (e) {
    console.error('renderLineChart error:', e);
  }
}


function destroyChart(id) {
  if (id === 'chartPie' && app.chartPie) {
    app.chartPie.destroy();
    app.chartPie = null;
  }
  if (id === 'chartLine' && app.chartLine) {
    app.chartLine.destroy();
    app.chartLine = null;
  }
}
// ===== Charts =====
app.chartPie = null;
app.chartLine = null;

function renderCharts() {
  renderPieChart();
  renderLineChart();
}

// ===== Portfolio Snapshots =====
async function saveSnapshotIfNeeded() {
  if (!app.user) return;

  try {
const portfolioId = app.currentPortfolioId || await ensureDefaultPortfolio(app.user.id);
    const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD

    // æª¢æŸ¥ä»Šæ—¥æœ‰å†‡å¿«ç…§
    const { data: existing } = await app.supabase
      .from('portfolio_snapshots')
      .select('id')
      .eq('user_id', app.user.id)
      .eq('portfolio_id', portfolioId)
      .eq('snapshot_date', today)
      .maybeSingle();

    if (existing) {
      console.log('âœ… ä»Šæ—¥å¿«ç…§å·²å­˜åœ¨ï¼Œå””é‡è¤‡ä¿å­˜');
      return; // å·²ç¶“æœ‰ï¼Œå””é‡è¤‡å­˜
    }

    // è¨ˆç®—ç•¶å‰ç¸½è³‡ç”¢ / ç¸½æ”¶ç›Š
    const { data: rows } = await app.supabase
      .from('holdings')
      .select('current_value, gain')
      .eq('user_id', app.user.id)
      .eq('portfolio_id', portfolioId);

    let totalValue = 0;
    let totalGain = 0;

    if (rows && rows.length > 0) {
      rows.forEach(r => {
        totalValue += Number(r.current_value || 0);
        totalGain += Number(r.gain || 0);
      });
    }

    const totalCost = totalValue - totalGain;
    const totalGainPercent = totalCost > 0 ? (totalGain / totalCost * 100) : 0;

    // å„²å­˜å¿«ç…§
    const { error } = await app.supabase
      .from('portfolio_snapshots')
      .insert([{
        user_id: app.user.id,
        portfolio_id: portfolioId,
        snapshot_date: today,
        total_value: totalValue,
        total_gain: totalGain,
        total_gain_percent: totalGainPercent,
        holdings_count: rows ? rows.length : 0
      }]);

    if (error) throw error;

    console.log('ğŸ’¾ å¿«ç…§å·²ä¿å­˜:', { date: today, totalValue, totalGain });
  } catch (e) {
    console.error('ä¿å­˜å¿«ç…§å¤±æ•—:', e);
  }
  
  
}

async function saveSnapshotManually() {
  if (!app.user) return alert('âŒ æœªç™»å…¥');

  const btn = document.getElementById('btnSaveSnapshot');
  
  try {
    if (btn) {
      btn.disabled = true;
      btn.textContent = 'ä¿å­˜ä¸­...';
    }

const portfolioId = app.currentPortfolioId || await ensureDefaultPortfolio(app.user.id);
    const today = new Date().toISOString().slice(0, 10);

    // è¨ˆç®—ç•¶å‰ç¸½è³‡ç”¢ / ç¸½æ”¶ç›Š
    const { data: rows } = await app.supabase
      .from('holdings')
      .select('current_value, gain')
      .eq('user_id', app.user.id)
      .eq('portfolio_id', portfolioId);

    let totalValue = 0;
    let totalGain = 0;

    if (rows && rows.length > 0) {
      rows.forEach(r => {
        totalValue += Number(r.current_value || 0);
        totalGain += Number(r.gain || 0);
      });
    }

    const totalCost = totalValue - totalGain;
    const totalGainPercent = totalCost > 0 ? (totalGain / totalCost * 100) : 0;

    // ç”¨ upsertï¼ˆå¦‚æœä»Šæ—¥å·²å­˜åœ¨å°±è¦†è“‹ï¼‰
    const { error } = await app.supabase
      .from('portfolio_snapshots')
      .upsert({
        user_id: app.user.id,
        portfolio_id: portfolioId,
        snapshot_date: today,
        total_value: totalValue,
        total_gain: totalGain,
        total_gain_percent: totalGainPercent,
        holdings_count: rows ? rows.length : 0
      }, {
        onConflict: 'user_id,portfolio_id,snapshot_date'
      });

    if (error) throw error;

    console.log('ğŸ“¸ æ‰‹å‹•å¿«ç…§å·²ä¿å­˜:', { date: today, totalValue });
    alert('âœ… å¿«ç…§å·²ä¿å­˜ï¼');

    // åˆ·æ–°è¶¨å‹¢åœ–
    await renderLineChart();

  } catch (e) {
    console.error('æ‰‹å‹•ä¿å­˜å¿«ç…§å¤±æ•—:', e);
    alert('ä¿å­˜å¤±æ•—ï¼š' + (e.message || e));
  } finally {
    if (btn) {
      btn.disabled = false;
      btn.textContent = 'ğŸ“¸ ä¿å­˜å¿«ç…§';
    }
  }
}


async function renderPieChart() {
  if (!app.user) return;

const portfolioId = app.currentPortfolioId || await ensureDefaultPortfolio(app.user.id);

  const { data: rows } = await app.supabase
  .from('holdings')
  .select('symbol, current_value')
  .eq('user_id', app.user.id)
  .eq('portfolio_id', portfolioId);



  if (!rows || rows.length === 0) {
    destroyChart('chartPie');
    return;
  }

  const labels = [];
  const data = [];
  const colors = [
    '#3b82f6', '#22c55e', '#eab308', '#ef4444', '#8b5cf6',
    '#ec4899', '#06b6d4', '#f97316', '#10b981', '#6366f1'
  ];

  rows.forEach(r => {
    labels.push((r.symbol || '').toUpperCase());
   data.push(Number(r.current_value || 0));
  });

  const ctx = document.getElementById('chartPie');
  if (!ctx) return;

  destroyChart('chartPie');

  app.chartPie = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: data,
        backgroundColor: colors.slice(0, labels.length),
        borderColor: '#020617',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'right',
          labels: { color: '#e5e7eb', font: { size: 11 } }
        },
        tooltip: {
          callbacks: {
            label: function(ctx) {
              const label = ctx.label || '';
              const value = ctx.parsed || 0;
              const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
              const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
              return `${label}: HK$ ${value.toFixed(2)} (${pct}%)`;
            }
          }
        }
      }
    }
  });
}

function renderLineChart() {
  const labels = [];
  const data = [];
  const today = new Date();

  const totalAssetsText = document.getElementById('totalAssets')?.textContent || 'HK$ 0';
  const totalAssets = Number(totalAssetsText.replace(/[^\d.-]/g, '')) || 10000;

  for (let i = 29; i >= 0; i--) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    labels.push(`${d.getMonth() + 1}/${d.getDate()}`);

    const variation = (Math.random() - 0.5) * 0.06;
    const val = totalAssets * (1 + variation * (i / 30));
    data.push(val);
  }

  data[data.length - 1] = totalAssets;

  const ctx = document.getElementById('chartLine');
  if (!ctx) return;

  destroyChart('chartLine');

  app.chartLine = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'ç¸½è³‡ç”¢ (HK$)',
        data: data,
        borderColor: '#22c55e',
        backgroundColor: 'rgba(34, 197, 94, 0.1)',
        borderWidth: 2,
        tension: 0.3,
        fill: true,
        pointRadius: 0,
        pointHoverRadius: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          mode: 'index',
          intersect: false,
          callbacks: {
            label: function(ctx) {
              return `ç¸½è³‡ç”¢: HK$ ${ctx.parsed.y.toFixed(2)}`;
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { color: '#9ca3af', font: { size: 10 } },
          grid: { color: '#1f2937' }
        },
        y: {
          ticks: {
            color: '#9ca3af',
            font: { size: 10 },
            callback: function(value) {
              return 'HK$ ' + value.toLocaleString();
            }
          },
          grid: { color: '#1f2937' }
        }
      }
    }
  });
}

function destroyChart(id) {
  if (id === 'chartPie' && app.chartPie) {
    app.chartPie.destroy();
    app.chartPie = null;
  }
  if (id === 'chartLine' && app.chartLine) {
    app.chartLine.destroy();
    app.chartLine = null;
  }
}


</script>
</body>
</html>
